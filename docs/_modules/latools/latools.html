

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>latools.latools &mdash; latools 0.3.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="latools 0.3.1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> latools
          

          
          </a>

          
            
            
              <div class="version">
                0.3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../users/index.html">User Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../latools.html">latools Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">latools</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>latools.latools</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for latools.latools</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">dateutil</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span> <span class="k">as</span> <span class="nn">pkgrs</span>
<span class="kn">import</span> <span class="nn">uncertainties</span> <span class="k">as</span> <span class="nn">unc</span>
<span class="kn">import</span> <span class="nn">uncertainties.unumpy</span> <span class="k">as</span> <span class="nn">un</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="k">import</span> <span class="n">minmax_scale</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>  <span class="c1"># status bars!</span>

<span class="kn">from</span> <span class="nn">.helpers</span> <span class="k">import</span> <span class="n">plot</span>
<span class="kn">from</span> <span class="nn">.filtering</span> <span class="k">import</span> <span class="n">filters</span>
<span class="kn">from</span> <span class="nn">.filtering.classifier_obj</span> <span class="k">import</span> <span class="n">classifier</span>

<span class="kn">from</span> <span class="nn">.D_obj</span> <span class="k">import</span> <span class="n">D</span>
<span class="kn">from</span> <span class="nn">.helpers.helpers</span> <span class="k">import</span> <span class="p">(</span><span class="n">rolling_window</span><span class="p">,</span> <span class="n">enumerate_bool</span><span class="p">,</span>
                      <span class="n">un_interp1d</span><span class="p">,</span> <span class="n">pretty_element</span><span class="p">,</span> <span class="n">get_date</span><span class="p">,</span>
                      <span class="n">unitpicker</span><span class="p">,</span> <span class="n">rangecalc</span><span class="p">,</span> <span class="n">Bunch</span><span class="p">,</span> <span class="n">calc_grads</span><span class="p">,</span> <span class="n">_log</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.helpers.stat_fns</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>  <span class="c1"># multi-index slicing!</span>

<span class="c1"># deactivate IPython deprecations warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
<span class="c1"># deactivate numpy invalid comparison warnings</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>


<span class="c1"># TODO: Allow full sklearn integration by allowing sample-wise application of custom classifiers. i.e. Provide data collection (get_data) ajd filter addition API.</span>
<span class="c1"># Especially: PCA, Gaussian Mixture Models</span>

<div class="viewcode-block" id="analyse"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse">[docs]</a><span class="k">class</span> <span class="nc">analyse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For processing and analysing whole LA - ICPMS datasets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_folder : str</span>
<span class="sd">        The path to a directory containing multiple data files.</span>
<span class="sd">    errorhunt : bool</span>
<span class="sd">        If True, latools prints the name of each file before it</span>
<span class="sd">        imports the data. This is useful for working out which </span>
<span class="sd">        data file is causing the import to fail.</span>
<span class="sd">    config : str</span>
<span class="sd">        The name of the configuration to use for the analysis.</span>
<span class="sd">        This determines which configuration set from the</span>
<span class="sd">        latools.cfg file is used, and overrides the default</span>
<span class="sd">        configuration setup. You might sepcify this if your lab</span>
<span class="sd">        routinely uses two different instruments.</span>
<span class="sd">    dataformat : str or dict</span>
<span class="sd">        Either a path to a data format file, or a</span>
<span class="sd">        dataformat dict. See documentation for more details.</span>
<span class="sd">    extension : str</span>
<span class="sd">        The file extension of your data files. Defaults to</span>
<span class="sd">        &#39;.csv&#39;.</span>
<span class="sd">    srm_identifier : str</span>
<span class="sd">        A string used to separate samples and standards. srm_identifier</span>
<span class="sd">        must be present in all standard measurements. Defaults to</span>
<span class="sd">        &#39;STD&#39;.</span>
<span class="sd">    cmap : dict</span>
<span class="sd">        A dictionary of {analyte: colour} pairs. Colour can be any valid</span>
<span class="sd">        matplotlib colour string, RGB or RGBA sequence, or hex string.</span>
<span class="sd">    time_format : str</span>
<span class="sd">        A regex string identifying the time format, used by pandas when</span>
<span class="sd">        created a universal time scale. If unspecified (None), pandas</span>
<span class="sd">        attempts to infer the time format, but in some cases this might</span>
<span class="sd">        not work.</span>
<span class="sd">    internal_standard : str</span>
<span class="sd">        The name of the analyte used as an internal standard throughout</span>
<span class="sd">        analysis.</span>
<span class="sd">    names : str</span>
<span class="sd">        * &#39;file_names&#39; : use the file names as labels (default)</span>
<span class="sd">        * &#39;metadata_names&#39; : used the &#39;names&#39; attribute of metadata as the name</span>
<span class="sd">          anything else : use numbers.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    folder : str</span>
<span class="sd">        Path to the directory containing the data files, as</span>
<span class="sd">        specified by `data_folder`.</span>
<span class="sd">    dirname : str</span>
<span class="sd">        The name of the directory containing the data files,</span>
<span class="sd">        without the entire path.</span>
<span class="sd">    files : array_like</span>
<span class="sd">        A list of all files in `folder`.</span>
<span class="sd">    param_dir : str</span>
<span class="sd">        The directory where parameters are stored.</span>
<span class="sd">    report_dir : str</span>
<span class="sd">        The directory where plots are saved.</span>
<span class="sd">    data : dict</span>
<span class="sd">        A dict of `latools.D` data objects, labelled by sample</span>
<span class="sd">        name.</span>
<span class="sd">    samples : array_like</span>
<span class="sd">        A list of samples.</span>
<span class="sd">    analytes : array_like</span>
<span class="sd">        A list of analytes measured.</span>
<span class="sd">    stds : array_like</span>
<span class="sd">        A list of the `latools.D` objects containing hte SRM</span>
<span class="sd">        data. These must contain srm_identifier in the file name.</span>
<span class="sd">    srm_identifier : str</span>
<span class="sd">        A string present in the file names of all standards.</span>
<span class="sd">    cmaps : dict</span>
<span class="sd">        An analyte - specific colour map, used for plotting.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">,</span> <span class="n">errorhunt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="s1">&#39;DEFAULT&#39;</span><span class="p">,</span>
                 <span class="n">dataformat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">srm_identifier</span><span class="o">=</span><span class="s1">&#39;STD&#39;</span><span class="p">,</span>
                 <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">internal_standard</span><span class="o">=</span><span class="s1">&#39;Ca43&#39;</span><span class="p">,</span>
                 <span class="n">names</span><span class="o">=</span><span class="s1">&#39;file_names&#39;</span><span class="p">,</span> <span class="n">srm_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For processing and analysing whole LA - ICPMS datasets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialise log</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;__init__ :: args=() kwargs=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">))]</span>

        <span class="c1"># assign file paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">data_folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
                               <span class="k">if</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">f</span><span class="p">])</span>

        <span class="c1"># make output directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">parent_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span>
                                 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_reports/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_dir</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">parent_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span>
                                 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_export/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_dir</span><span class="p">)</span>

        <span class="c1"># load configuration parameters</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>  <span class="c1"># read in config file</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pkgrs</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;latools&#39;</span><span class="p">,</span> <span class="s1">&#39;latools.cfg&#39;</span><span class="p">))</span>
        <span class="c1"># load defaults into dict</span>
        <span class="n">pconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">defaults</span><span class="p">())</span>
        <span class="c1"># if no config is given, check to see what the default setting is</span>
        <span class="c1"># if (config is None) &amp; (pconf[&#39;config&#39;] != &#39;DEFAULT&#39;):</span>
        <span class="c1">#     config = pconf[&#39;config&#39;]</span>
        <span class="c1"># else:</span>
        <span class="c1">#     config = &#39;DEFAULT&#39;</span>

        <span class="c1"># if there are any non - default parameters, replace defaults in</span>
        <span class="c1"># the pconf dict</span>
        <span class="k">if</span> <span class="n">config</span> <span class="o">!=</span> <span class="s1">&#39;DEFAULT&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
                <span class="n">pconf</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;latools analysis using &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">+</span> <span class="s1">&#39;&quot; configuration:&#39;</span><span class="p">)</span>

        <span class="c1"># check srmfile exists, and store it in a class attribute.</span>
        <span class="k">if</span> <span class="n">srm_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">srm_file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">srmfile</span> <span class="o">=</span> <span class="n">srm_file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s1">&#39;Cannot find the specified SRM file:</span><span class="se">\n</span><span class="s1">   &#39;</span> <span class="o">+</span>
                                  <span class="n">srm_file</span> <span class="o">+</span>
                                  <span class="s1">&#39;Please check that the file location is correct.&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pconf</span><span class="p">[</span><span class="s1">&#39;srmfile&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">srmfile</span> <span class="o">=</span> <span class="n">pconf</span><span class="p">[</span><span class="s1">&#39;srmfile&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pkgrs</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;latools&#39;</span><span class="p">,</span>
                                                        <span class="n">pconf</span><span class="p">[</span><span class="s1">&#39;srmfile&#39;</span><span class="p">])):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">srmfile</span> <span class="o">=</span> <span class="n">pkgrs</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;latools&#39;</span><span class="p">,</span>
                                                       <span class="n">pconf</span><span class="p">[</span><span class="s1">&#39;srmfile&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s1">&#39;The SRM file specified in the &#39;</span> <span class="o">+</span> <span class="n">config</span> <span class="o">+</span>
                                  <span class="s1">&#39; configuration cannot be found.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                  <span class="s1">&#39;Please make sure the file exists, and that the &#39;</span>
                                  <span class="s1">&#39;path in the config file is correct.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                  <span class="s1">&#39;To locate the config file, run &#39;</span>
                                  <span class="s1">&#39;`latools.config_locator()`.</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                                  <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">config</span> <span class="o">+</span> <span class="s1">&#39; file: &#39;</span> <span class="o">+</span> <span class="n">pconf</span><span class="p">[</span><span class="s1">&#39;srmfile&#39;</span><span class="p">]))</span>

        <span class="c1"># load in dataformat information.</span>
        <span class="c1"># check dataformat file exists, and store it in a class attribute.</span>
        <span class="c1"># if dataformat is not provided during initialisation, assign it</span>
        <span class="c1"># from configuration file</span>
        <span class="k">if</span> <span class="n">dataformat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pconf</span><span class="p">[</span><span class="s1">&#39;dataformat&#39;</span><span class="p">]):</span>
                <span class="n">dataformat</span> <span class="o">=</span> <span class="n">pconf</span><span class="p">[</span><span class="s1">&#39;dataformat&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pkgrs</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;latools&#39;</span><span class="p">,</span>
                                                        <span class="n">pconf</span><span class="p">[</span><span class="s1">&#39;dataformat&#39;</span><span class="p">])):</span>
                <span class="n">dataformat</span> <span class="o">=</span> <span class="n">pkgrs</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;latools&#39;</span><span class="p">,</span>
                                                     <span class="n">pconf</span><span class="p">[</span><span class="s1">&#39;dataformat&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s1">&#39;The dataformat file specified in the &#39;</span> <span class="o">+</span>
                                  <span class="n">config</span> <span class="o">+</span> <span class="s1">&#39; configuration cannot be found.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                  <span class="s1">&#39;Please make sure the file exists, and that &#39;</span>
                                  <span class="s1">&#39;the path in the config file is correct.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                  <span class="s1">&#39;To locate the config file, run &#39;</span>
                                  <span class="s1">&#39;`latools.config_locator()`.</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                  <span class="n">config</span> <span class="o">+</span> <span class="s1">&#39; file: &#39;</span> <span class="o">+</span> <span class="n">dataformat</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataformat_file</span> <span class="o">=</span> <span class="n">dataformat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataformat_file</span> <span class="o">=</span> <span class="s1">&#39;None: dict provided&#39;</span>

        <span class="c1"># if it&#39;s a string, check the file exists and import it.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataformat</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dataformat</span><span class="p">):</span>
                <span class="c1"># self.dataformat = eval(open(dataformat).read())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataformat</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">dataformat</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span><span class="s2">&quot;The dataformat file (&quot;</span> <span class="o">+</span> <span class="n">dataformat</span> <span class="o">+</span>
                               <span class="s2">&quot;) cannot be found.</span><span class="se">\n</span><span class="s2">Please make sure the file &quot;</span>
                               <span class="s2">&quot;exists, and that the path is correct.</span><span class="se">\n\n</span><span class="s2">File &quot;</span>
                               <span class="s2">&quot;Path: &quot;</span> <span class="o">+</span> <span class="n">dataformat</span><span class="p">))</span>

        <span class="c1"># if it&#39;s a dict, just assign it straight away.</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataformat</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataformat</span> <span class="o">=</span> <span class="n">dataformat</span>

        <span class="c1"># load data into list (initialise D objects)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span>
                  <span class="n">dataformat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataformat</span><span class="p">,</span>
                  <span class="n">errorhunt</span><span class="o">=</span><span class="n">errorhunt</span><span class="p">,</span>
                  <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                  <span class="n">internal_standard</span><span class="o">=</span><span class="n">internal_standard</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="n">names</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">]</span>

        <span class="c1"># create universal time scale</span>
        <span class="k">if</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;time_format&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataformat</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">time_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataformat</span><span class="p">[</span><span class="s1">&#39;time_format&#39;</span><span class="p">]</span>

            <span class="n">start_times</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_date</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">time_format</span><span class="p">))</span>
            <span class="n">min_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_times</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">start_times</span><span class="p">):</span>
                <span class="n">d</span><span class="o">.</span><span class="n">uTime</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Time</span> <span class="o">+</span> <span class="p">(</span><span class="n">st</span> <span class="o">-</span> <span class="n">min_time</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">uTime</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Time</span> <span class="o">+</span> <span class="n">ts</span>
                <span class="n">ts</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="n">Time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Time not determined from dataformat. Universal time scale</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;approximated as continuously measured samples.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;Samples might not be in the right order.</span><span class="se">\n</span><span class="s2">&quot;</span>
                          <span class="s2">&quot;Background correction and calibration may not behave</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;as expected.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">uTime</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>

        <span class="c1"># sort data by uTime</span>
        <span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">uTime</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># process sample names</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">names</span> <span class="o">==</span> <span class="s1">&#39;file_names&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">names</span> <span class="o">==</span> <span class="s1">&#39;metadata_names&#39;</span><span class="p">):</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">sample</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">data</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>  <span class="c1"># get all sample names</span>
            <span class="c1"># if duplicates, rename them</span>
            <span class="n">usamples</span><span class="p">,</span> <span class="n">ucounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">usamples</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">samples</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">dups</span> <span class="o">=</span> <span class="n">usamples</span><span class="p">[</span><span class="n">ucounts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># identify duplicates</span>
                <span class="n">nreps</span> <span class="o">=</span> <span class="n">ucounts</span><span class="p">[</span><span class="n">ucounts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># identify how many times they repeat</span>
                <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dups</span><span class="p">,</span> <span class="n">nreps</span><span class="p">):</span>  <span class="c1"># cycle through duplicates</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>  <span class="c1"># append number to duplicate names</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">samples</span> <span class="o">==</span> <span class="n">d</span>
                    <span class="n">samples</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>  <span class="c1"># rename in samples</span>
                    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">ns</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">new</span><span class="p">):</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">ns</span>  <span class="c1"># rename in D objects</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>  <span class="c1"># assign a range of numbers</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span>

        <span class="c1"># copy colour map to top level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cmap</span>

        <span class="c1"># get analytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">analytes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">internal_standard</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span> <span class="o">=</span> <span class="n">internal_standard</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The internal standard (</span><span class="si">{}</span><span class="s1">) is not amongst the&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">internal_standard</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;analytes in</span><span class="se">\n</span><span class="s1">your data files. Please make sure it is specified correctly.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">internal_standard</span><span class="p">])</span>

        <span class="c1"># From this point on, data stored in dicts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

        <span class="c1"># get SRM info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srm_identifier</span> <span class="o">=</span> <span class="n">srm_identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stds</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># make this a dict</span>
        <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">srm_identifier</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">sample</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srms_ided</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># set up focus_stage recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span> <span class="o">=</span> <span class="s1">&#39;rawdata&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focus</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>

        <span class="c1"># set up subsets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_subsets</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subset_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;All_Analyses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">srm_identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">srm_identifier</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;All_Samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">srm_identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;not_in_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;All_Samples&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># initialise classifiers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifiers</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>

        <span class="c1"># report</span>
        <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;  </span><span class="si">{:.0f}</span><span class="s1"> Data Files Loaded: </span><span class="si">{:.0f}</span><span class="s1"> standards, </span><span class="si">{:.0f}</span><span class="s1"> &#39;</span>
               <span class="s1">&#39;samples&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stds</span><span class="p">),</span>
                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stds</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Analytes: &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analytes</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Internal Standard: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">))</span>

    <span class="c1"># Helper Functions</span>
    <span class="c1"># def _log(func):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Function for logging method calls and parameters</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     @wraps(func)</span>
    <span class="c1">#     def wrapper(self, *args, **kwargs):</span>
    <span class="c1">#         a = func(self, *args, **kwargs)</span>
    <span class="c1">#         self.log.append(func.__name__ + &#39; :: args={} kwargs={}&#39;.format(args, kwargs))</span>
    <span class="c1">#         return a</span>
    <span class="c1">#     return wrapper</span>

    <span class="k">def</span> <span class="nf">_get_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to get sample names from subset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        subset : str</span>
<span class="sd">            Subset name. If None, returns all samples.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List of sample names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;All_Samples&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">((</span><span class="s2">&quot;Subset &#39;</span><span class="si">{:s}</span><span class="s2">&#39; does not &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s2">&quot;exist.</span><span class="se">\n</span><span class="s2">Use &#39;make_subset&#39; to create a&quot;</span> <span class="o">+</span>
                                <span class="s2">&quot;subset.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">samples</span>

<div class="viewcode-block" id="analyse.basic_processing"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.basic_processing">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">basic_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">noise_despiker</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">despike_win</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">despike_nlim</span><span class="o">=</span><span class="mf">12.</span><span class="p">,</span>  <span class="c1"># despike args</span>
                         <span class="n">despike_maxiter</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                         <span class="n">autorange_analyte</span><span class="o">=</span><span class="s1">&#39;total_counts&#39;</span><span class="p">,</span> <span class="n">autorange_gwin</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">autorange_swin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">autorange_win</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>  <span class="c1"># autorange args</span>
                         <span class="n">autorange_on_mult</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span> <span class="n">autorange_off_mult</span><span class="o">=</span><span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">autorange_nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                         <span class="n">autorange_transform</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">autorange_thresh_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">bkg_weight_fwhm</span><span class="o">=</span><span class="mf">300.</span><span class="p">,</span>  <span class="c1"># bkg_calc_weightedmean</span>
                         <span class="n">bkg_n_min</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">bkg_n_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bkg_cstep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">bkg_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bkg_f_win</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">bkg_f_n_lim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                         <span class="n">bkg_errtype</span><span class="o">=</span><span class="s1">&#39;stderr&#39;</span><span class="p">,</span>  <span class="c1"># bkg_sub</span>
                         <span class="n">calib_drift_correct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># calibrate</span>
                         <span class="n">calib_srms_used</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NIST610&#39;</span><span class="p">,</span> <span class="s1">&#39;NIST612&#39;</span><span class="p">,</span> <span class="s1">&#39;NIST614&#39;</span><span class="p">],</span>
                         <span class="n">calib_zero_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">calib_n_min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                         <span class="n">plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">despike</span><span class="p">(</span><span class="n">noise_despiker</span><span class="o">=</span><span class="n">noise_despiker</span><span class="p">,</span>
                     <span class="n">win</span><span class="o">=</span><span class="n">despike_win</span><span class="p">,</span> <span class="n">nlim</span><span class="o">=</span><span class="n">despike_nlim</span><span class="p">,</span>
                     <span class="n">maxiter</span><span class="o">=</span><span class="n">despike_maxiter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autorange</span><span class="p">(</span><span class="n">analyte</span><span class="o">=</span><span class="n">autorange_analyte</span><span class="p">,</span> <span class="n">gwin</span><span class="o">=</span><span class="n">autorange_gwin</span><span class="p">,</span> <span class="n">swin</span><span class="o">=</span><span class="n">autorange_swin</span><span class="p">,</span>
                       <span class="n">win</span><span class="o">=</span><span class="n">autorange_win</span><span class="p">,</span> <span class="n">on_mult</span><span class="o">=</span><span class="n">autorange_on_mult</span><span class="p">,</span>
                       <span class="n">off_mult</span><span class="o">=</span><span class="n">autorange_off_mult</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">autorange_nbin</span><span class="p">,</span>
                       <span class="n">transform</span><span class="o">=</span><span class="n">autorange_transform</span><span class="p">,</span> <span class="n">thresh_n</span><span class="o">=</span><span class="n">autorange_thresh_n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_plots</span><span class="p">(</span><span class="n">ranges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkg_calc_weightedmean</span><span class="p">(</span><span class="n">weight_fwhm</span><span class="o">=</span><span class="n">bkg_weight_fwhm</span><span class="p">,</span> <span class="n">n_min</span><span class="o">=</span><span class="n">bkg_n_min</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="n">bkg_n_max</span><span class="p">,</span>
                                   <span class="n">cstep</span><span class="o">=</span><span class="n">bkg_cstep</span><span class="p">,</span> <span class="n">bkg_filter</span><span class="o">=</span><span class="n">bkg_filter</span><span class="p">,</span> <span class="n">f_win</span><span class="o">=</span><span class="n">bkg_f_win</span><span class="p">,</span> <span class="n">f_n_lim</span><span class="o">=</span><span class="n">bkg_f_n_lim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg_plot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkg_subtract</span><span class="p">(</span><span class="n">errtype</span><span class="o">=</span><span class="n">bkg_errtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">drift_correct</span><span class="o">=</span><span class="n">calib_drift_correct</span><span class="p">,</span> <span class="n">srms_used</span><span class="o">=</span><span class="n">calib_srms_used</span><span class="p">,</span>
                       <span class="n">zero_intercept</span><span class="o">=</span><span class="n">calib_zero_intercept</span><span class="p">,</span> <span class="n">n_min</span><span class="o">=</span><span class="n">calib_n_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_plot</span><span class="p">()</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.autorange"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.autorange">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">autorange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyte</span><span class="o">=</span><span class="s1">&#39;total_counts&#39;</span><span class="p">,</span> <span class="n">gwin</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">swin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                  <span class="n">on_mult</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span> <span class="n">off_mult</span><span class="o">=</span><span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                  <span class="n">transform</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">thresh_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ploterrs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically separates signal and background data regions.</span>

<span class="sd">        Automatically detect signal and background regions in the laser</span>
<span class="sd">        data, based on the behaviour of a single analyte. The analyte used</span>
<span class="sd">        should be abundant and homogenous in the sample.</span>

<span class="sd">        **Step 1: Thresholding.**</span>
<span class="sd">        The background signal is determined using a gaussian kernel density</span>
<span class="sd">        estimator (kde) of all the data. Under normal circumstances, this</span>
<span class="sd">        kde should find two distinct data distributions, corresponding to</span>
<span class="sd">        &#39;signal&#39; and &#39;background&#39;. The minima between these two distributions</span>
<span class="sd">        is taken as a rough threshold to identify signal and background</span>
<span class="sd">        regions. Any point where the trace crosses this thrshold is identified</span>
<span class="sd">        as a &#39;transition&#39;.</span>

<span class="sd">        **Step 2: Transition Removal.**</span>
<span class="sd">        The width of the transition regions between signal and background are</span>
<span class="sd">        then determined, and the transitions are excluded from analysis. The</span>
<span class="sd">        width of the transitions is determined by fitting a gaussian to the</span>
<span class="sd">        smoothed first derivative of the analyte trace, and determining its</span>
<span class="sd">        width at a point where the gaussian intensity is at at `conf` time the</span>
<span class="sd">        gaussian maximum. These gaussians are fit to subsets of the data</span>
<span class="sd">        centered around the transitions regions determined in Step 1, +/- `win`</span>
<span class="sd">        data points. The peak is further isolated by finding the minima and</span>
<span class="sd">        maxima of a second derivative within this window, and the gaussian is</span>
<span class="sd">        fit to the isolated peak.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analyte : str</span>
<span class="sd">            The analyte that autorange should consider. For best results,</span>
<span class="sd">            choose an analyte that is present homogeneously in high</span>
<span class="sd">            concentrations.</span>
<span class="sd">            This can also be &#39;total_counts&#39; to use the sum of all analytes.</span>
<span class="sd">        gwin : int</span>
<span class="sd">            The smoothing window used for calculating the first derivative.</span>
<span class="sd">            Must be odd.</span>
<span class="sd">        win : int</span>
<span class="sd">            Determines the width (c +/- win) of the transition data subsets.</span>
<span class="sd">        smwin : int</span>
<span class="sd">            The smoothing window used for calculating the second derivative.</span>
<span class="sd">            Must be odd.</span>
<span class="sd">        conf : float</span>
<span class="sd">            The proportional intensity of the fitted gaussian tails that</span>
<span class="sd">            determines the transition width cutoff (lower = wider transition</span>
<span class="sd">            regions excluded).</span>
<span class="sd">        trans_mult : array_like, len=2</span>
<span class="sd">            Multiples of the peak FWHM to add to the transition cutoffs, e.g.</span>
<span class="sd">            if the transitions consistently leave some bad data proceeding the</span>
<span class="sd">            transition, set trans_mult to [0, 0.5] to ad 0.5 * the FWHM to the</span>
<span class="sd">            right hand side of the limit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Outputs added as instance attributes. Returns None.</span>
<span class="sd">        bkg, sig, trn : iterable, bool</span>
<span class="sd">            Boolean arrays identifying background, signal and transision</span>
<span class="sd">            regions</span>
<span class="sd">        bkgrng, sigrng and trnrng : iterable</span>
<span class="sd">            (min, max) pairs identifying the boundaries of contiguous</span>
<span class="sd">            True regions in the boolean arrays.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bkg_thresh</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">analyte</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analyte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span>
        <span class="k">elif</span> <span class="n">analyte</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">analyte</span><span class="p">])</span>

        <span class="n">fails</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># list for catching failures.</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;AutoRange&#39;</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">autorange</span><span class="p">(</span><span class="n">analyte</span><span class="o">=</span><span class="n">analyte</span><span class="p">,</span> <span class="n">gwin</span><span class="o">=</span><span class="n">gwin</span><span class="p">,</span> <span class="n">swin</span><span class="o">=</span><span class="n">swin</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span>
                            <span class="n">on_mult</span><span class="o">=</span><span class="n">on_mult</span><span class="p">,</span> <span class="n">off_mult</span><span class="o">=</span><span class="n">off_mult</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span>
                            <span class="n">ploterrs</span><span class="o">=</span><span class="n">ploterrs</span><span class="p">,</span> <span class="n">bkg_thresh</span><span class="o">=</span><span class="n">bkg_thresh</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fails</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
        <span class="c1"># handle failures</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fails</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wstr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">41</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;                 WARNING</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">41</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;Autorange failed for some samples:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">kwidth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fails</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">fstr</span> <span class="o">=</span> <span class="s1">&#39;  {:&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwidth</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;s}: &#39;</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fails</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">wstr</span> <span class="o">+=</span> <span class="n">fstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fails</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">wstr</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*** THIS IS NOT NECESSARILY A PROBLEM ***</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;But please check the plots below to make</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;sure they look OK. Failures are marked by</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;dashed vertical red lines.</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;To examine an autorange failure in more</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;detail, use the `autorange_plot` method</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;of the failing data object, e.g.:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                     <span class="s2">&quot;dat.data[&#39;Sample&#39;].autorange_plot(params)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                     <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">41</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">wstr</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.find_expcoef"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.find_expcoef">[docs]</a>    <span class="k">def</span> <span class="nf">find_expcoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsd_below</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">analyte</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">trimlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autorange_kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines exponential decay coefficient for despike filter.</span>

<span class="sd">        Fits an exponential decay function to the washout phase of standards</span>
<span class="sd">        to determine the washout time of your laser cell. The exponential</span>
<span class="sd">        coefficient reported is `nsd_below` standard deviations below the</span>
<span class="sd">        fitted exponent, to ensure that no real data is removed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nsd_below : float</span>
<span class="sd">            The number of standard deviations to subtract from the fitted</span>
<span class="sd">            coefficient when calculating the filter exponent.</span>
<span class="sd">        analyte : str</span>
<span class="sd">            The analyte to consider when determining the coefficient.</span>
<span class="sd">            Use high - concentration analyte for best estimates.</span>
<span class="sd">        plot : bool or str</span>
<span class="sd">            If True, creates a plot of the fit, if str the plot is to the</span>
<span class="sd">            location specified in str.</span>
<span class="sd">        trimlim : float</span>
<span class="sd">            A threshold limit used in determining the start of the</span>
<span class="sd">            exponential decay region of the washout. Defaults to half</span>
<span class="sd">            the increase in signal over background. If the data in</span>
<span class="sd">            the plot don&#39;t fall on an exponential decay line, change</span>
<span class="sd">            this number. Normally you&#39;ll need to increase it.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analyte</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analyte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">analyte</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating exponential decay coefficient</span><span class="se">\n</span><span class="s1">from SRM </span><span class="si">{}</span><span class="s1"> washouts...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">analyte</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">findtrim</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">trr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">trr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lim</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">tr</span> <span class="o">-</span> <span class="n">trr</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span> <span class="o">-</span> <span class="n">trr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lim</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">))[</span><span class="n">ind</span> <span class="o">^</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;trnrng&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">autorange</span><span class="p">(</span><span class="o">**</span><span class="n">autorange_kwargs</span><span class="p">,</span> <span class="n">ploterrs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">trans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">trnrng</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">trnrng</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">minmax_scale</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="n">analyte</span><span class="p">][(</span><span class="n">v</span><span class="o">.</span><span class="n">Time</span> <span class="o">&gt;</span> <span class="n">trnrng</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">Time</span> <span class="o">&lt;</span> <span class="n">trnrng</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
                <span class="n">sm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                         <span class="n">rolling_window</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">sm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">trim</span> <span class="o">=</span> <span class="n">findtrim</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">trimlim</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="n">trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minmax_scale</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="n">trim</span><span class="p">:]))</span>
                <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="n">trim</span><span class="p">:]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">Time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>

        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>

        <span class="n">ti</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">ti</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">trans</span><span class="p">[</span><span class="n">times</span> <span class="o">==</span> <span class="n">t</span><span class="p">]))</span>

        <span class="k">def</span> <span class="nf">expfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Exponential decay function.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">e</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>

        <span class="n">ep</span><span class="p">,</span> <span class="n">ecov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">expfit</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span>

        <span class="n">eeR2</span> <span class="o">=</span> <span class="n">R2calc</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">expfit</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">ep</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
            <span class="n">fitx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">ti</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fitx</span><span class="p">,</span> <span class="n">expfit</span><span class="p">(</span><span class="n">fitx</span><span class="p">,</span> <span class="n">ep</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fitx</span><span class="p">,</span> <span class="n">expfit</span><span class="p">(</span><span class="n">fitx</span><span class="p">,</span> <span class="n">ep</span> <span class="o">-</span> <span class="n">nsd_below</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">ecov</span><span class="p">)</span><span class="o">**.</span><span class="mi">5</span><span class="p">,</span> <span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Used&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;y = $e^{</span><span class="si">%.2f</span><span class="s1"> \pm </span><span class="si">%.2f</span><span class="s1"> * x}$</span><span class="se">\n</span><span class="s1">$R^2$= </span><span class="si">%.2f</span><span class="s1"> </span><span class="se">\n</span><span class="s1">Coefficient: &#39;</span>
                     <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">ecov</span><span class="p">)</span><span class="o">**.</span><span class="mi">5</span><span class="p">,</span>
                                <span class="n">eeR2</span><span class="p">,</span>
                                <span class="n">ep</span> <span class="o">-</span> <span class="n">nsd_below</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">ecov</span><span class="p">)</span><span class="o">**.</span><span class="mi">5</span><span class="p">),</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Proportion of Signal&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expdecay_coef</span> <span class="o">=</span> <span class="n">ep</span> <span class="o">-</span> <span class="n">nsd_below</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">ecov</span><span class="p">)</span><span class="o">**.</span><span class="mi">5</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{:0.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expdecay_coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.despike"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.despike">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">despike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expdecay_despiker</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tstep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">noise_despiker</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nlim</span><span class="o">=</span><span class="mf">12.</span><span class="p">,</span> <span class="n">exponentplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">maxiter</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">autorange_kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Despikes data with exponential decay and noise filters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        expdecay_despiker : bool</span>
<span class="sd">            Whether or not to apply the exponential decay filter.</span>
<span class="sd">        exponent : None or float</span>
<span class="sd">            The exponent for the exponential decay filter. If None,</span>
<span class="sd">            it is determined automatically using `find_expocoef`.</span>
<span class="sd">        tstep : None or float</span>
<span class="sd">            The timeinterval between measurements. If None, it is</span>
<span class="sd">            determined automatically from the Time variable.</span>
<span class="sd">        noise_despiker : bool</span>
<span class="sd">            Whether or not to apply the standard deviation spike filter.</span>
<span class="sd">        win : int</span>
<span class="sd">            The rolling window over which the spike filter calculates</span>
<span class="sd">            the trace statistics.</span>
<span class="sd">        nlim : float</span>
<span class="sd">            The number of standard deviations above the rolling mean</span>
<span class="sd">            that data are excluded.</span>
<span class="sd">        exponentplot : bool</span>
<span class="sd">            Whether or not to show a plot of the automatically determined</span>
<span class="sd">            exponential decay exponent.</span>
<span class="sd">        maxiter : int</span>
<span class="sd">            The max number of times that the fitler is applied.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">expdecay_despiker</span> <span class="ow">and</span> <span class="n">exponent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;expdecay_coef&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">find_expcoef</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">exponentplot</span><span class="p">,</span>
                                  <span class="n">autorange_kwargs</span><span class="o">=</span><span class="n">autorange_kwargs</span><span class="p">)</span>
            <span class="n">exponent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expdecay_coef</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Despiking&#39;</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">despike</span><span class="p">(</span><span class="n">expdecay_despiker</span><span class="p">,</span> <span class="n">exponent</span><span class="p">,</span> <span class="n">tstep</span><span class="p">,</span>
                      <span class="n">noise_despiker</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">nlim</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span> <span class="o">=</span> <span class="s1">&#39;despiked&#39;</span>
        <span class="k">return</span></div>

    <span class="c1"># functions for background correction</span>
<div class="viewcode-block" id="analyse.get_background"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.get_background">[docs]</a>    <span class="k">def</span> <span class="nf">get_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">focus_stage</span><span class="o">=</span><span class="s1">&#39;despiked&#39;</span><span class="p">,</span> <span class="n">bkg_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">f_win</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">f_n_lim</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract all background data from all samples on universal time scale.</span>
<span class="sd">        Used by both &#39;polynomial&#39; and &#39;weightedmean&#39; methods.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_min : int</span>
<span class="sd">            The minimum number of points a background region must</span>
<span class="sd">            have to be included in calculation.</span>
<span class="sd">        n_max : int</span>
<span class="sd">            The maximum number of points a background region must</span>
<span class="sd">            have to be included in calculation.</span>
<span class="sd">        filter : bool</span>
<span class="sd">            If true, apply a rolling filter to the isolated background regions</span>
<span class="sd">            to exclude regions with anomalously high values. If True, two parameters</span>
<span class="sd">            alter the filter&#39;s behaviour:</span>
<span class="sd">        f_win : int</span>
<span class="sd">            The size of the rolling window</span>
<span class="sd">        f_n_lim : float</span>
<span class="sd">            The number of standard deviations above the rolling mean</span>
<span class="sd">            to set the threshold.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame object containing background data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">allbkgs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uTime&#39;</span><span class="p">:</span> <span class="p">[],</span>
                   <span class="s1">&#39;ns&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span><span class="p">:</span>
            <span class="n">allbkgs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">n0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">bkg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">allbkgs</span><span class="p">[</span><span class="s1">&#39;uTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">uTime</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">bkg</span><span class="p">])</span>
                <span class="n">allbkgs</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enumerate_bool</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">bkg</span><span class="p">,</span> <span class="n">n0</span><span class="p">)[</span><span class="n">s</span><span class="o">.</span><span class="n">bkg</span><span class="p">])</span>
                <span class="n">n0</span> <span class="o">=</span> <span class="n">allbkgs</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span><span class="p">:</span>
                    <span class="n">allbkgs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">focus_stage</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">s</span><span class="o">.</span><span class="n">bkg</span><span class="p">])</span>

        <span class="n">allbkgs</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">allbkgs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">bkgs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">allbkgs</span><span class="p">)</span>  <span class="c1"># using pandas here because it&#39;s much more efficient than loops.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
        <span class="c1"># extract background data from whole dataset</span>
        <span class="k">if</span> <span class="n">n_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkgs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_min</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkgs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_max</span><span class="p">))</span>
        <span class="c1"># calculate per - background region stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">,</span> <span class="n">stderr</span><span class="p">])</span>
        <span class="c1"># sort summary by uTime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">((</span><span class="s1">&#39;uTime&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># self.bkg[&#39;summary&#39;].index = np.arange(self.bkg[&#39;summary&#39;].shape[0])</span>
        <span class="c1"># self.bkg[&#39;summary&#39;].index.name = &#39;ns&#39;</span>

        <span class="k">if</span> <span class="n">bkg_filter</span><span class="p">:</span>
            <span class="c1"># calculate rolling mean and std from summary</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[:,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">f_win</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">])</span>
            <span class="c1"># calculate upper threshold</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[:,</span> <span class="p">:,</span> <span class="s1">&#39;nanmean&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">f_n_lim</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[:,</span> <span class="p">:,</span> <span class="s1">&#39;nanstd&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># calculate which are over upper threshold</span>
            <span class="n">over</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[:,</span> <span class="p">:,</span> <span class="s1">&#39;nanmean&#39;</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">upper</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># identify them</span>
            <span class="n">ns_drop</span> <span class="o">=</span> <span class="n">over</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">over</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">any</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># drop them from summary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">ns_drop</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># remove them from raw</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">ns_drop</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;ns&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ns</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.bkg_calc_weightedmean"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.bkg_calc_weightedmean">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">bkg_calc_weightedmean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weight_fwhm</span><span class="o">=</span><span class="mf">300.</span><span class="p">,</span>
                              <span class="n">n_min</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cstep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">bkg_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">f_win</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">f_n_lim</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Background calculation using a gaussian weighted mean.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : str or iterable</span>
<span class="sd">            Which analyte or analytes to calculate.</span>
<span class="sd">        weight_fwhm : float</span>
<span class="sd">            The full-width-at-half-maximum of the gaussian used</span>
<span class="sd">            to calculate the weighted average.</span>
<span class="sd">        n_min : int</span>
<span class="sd">            Background regions with fewer than n_min points</span>
<span class="sd">            will not be included in the fit.</span>
<span class="sd">        cstep : float or None</span>
<span class="sd">            The interval between calculated background points.</span>
<span class="sd">        filter : bool</span>
<span class="sd">            If true, apply a rolling filter to the isolated background regions</span>
<span class="sd">            to exclude regions with anomalously high values. If True, two parameters</span>
<span class="sd">            alter the filter&#39;s behaviour:</span>
<span class="sd">        f_win : int</span>
<span class="sd">            The size of the rolling window</span>
<span class="sd">        f_n_lim : float</span>
<span class="sd">            The number of standard deviations above the rolling mean</span>
<span class="sd">            to set the threshold.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_background</span><span class="p">(</span><span class="n">n_min</span><span class="o">=</span><span class="n">n_min</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="n">n_max</span><span class="p">,</span>
                            <span class="n">bkg_filter</span><span class="o">=</span><span class="n">bkg_filter</span><span class="p">,</span>
                            <span class="n">f_win</span><span class="o">=</span><span class="n">f_win</span><span class="p">,</span> <span class="n">f_n_lim</span><span class="o">=</span><span class="n">f_n_lim</span><span class="p">)</span>

        <span class="c1"># Gaussian - weighted average</span>
        <span class="k">if</span> <span class="s1">&#39;calc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># create time points to calculate background</span>
            <span class="k">if</span> <span class="n">cstep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cstep</span> <span class="o">=</span> <span class="n">weight_fwhm</span> <span class="o">/</span> <span class="mi">20</span>
            <span class="k">elif</span> <span class="n">cstep</span> <span class="o">&gt;</span> <span class="n">weight_fwhm</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">cstep should be less than weight_fwhm. Your backgrounds</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                              <span class="s2">&quot;might not behave as expected.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># TODO: Modify bkg_t to make sure none of the calculated</span>
            <span class="c1"># bkg points are during a sample collection? Though shouldn&#39;t</span>
            <span class="c1"># be a problem with gaussian smooth if bkgs are behaving</span>
            <span class="c1"># correctly.</span>
            <span class="n">bkg_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">max_time</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">//</span> <span class="n">cstep</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="s1">&#39;uTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_t</span>

        <span class="c1"># TODO : calculation then dict assignment is clumsy...</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">gauss_weighted_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">uTime</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">analytes</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="s1">&#39;uTime&#39;</span><span class="p">],</span>
                                                 <span class="n">fwhm</span><span class="o">=</span><span class="n">weight_fwhm</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">analytes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">mean</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                   <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">std</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                   <span class="s1">&#39;stderr&#39;</span><span class="p">:</span> <span class="n">stderr</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span></div>

<div class="viewcode-block" id="analyse.bkg_calc_interp1d"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.bkg_calc_interp1d">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">bkg_calc_interp1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cstep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">bkg_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">f_win</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">f_n_lim</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Background calculation using a 1D interpolation.</span>

<span class="sd">        scipy.interpolate.interp1D is used for interpolation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : str or iterable</span>
<span class="sd">            Which analyte or analytes to calculate.</span>
<span class="sd">        kind : str or int</span>
<span class="sd">            Integer specifying the order of the spline interpolation</span>
<span class="sd">            used, or string specifying a type of interpolation.</span>
<span class="sd">            Passed to `scipy.interpolate.interp1D`</span>
<span class="sd">        n_min : int</span>
<span class="sd">            Background regions with fewer than n_min points</span>
<span class="sd">            will not be included in the fit.</span>
<span class="sd">        cstep : float or None</span>
<span class="sd">            The interval between calculated background points.</span>
<span class="sd">        filter : bool</span>
<span class="sd">            If true, apply a rolling filter to the isolated background regions</span>
<span class="sd">            to exclude regions with anomalously high values. If True, two parameters</span>
<span class="sd">            alter the filter&#39;s behaviour:</span>
<span class="sd">        f_win : int</span>
<span class="sd">            The size of the rolling window</span>
<span class="sd">        f_n_lim : float</span>
<span class="sd">            The number of standard deviations above the rolling mean</span>
<span class="sd">            to set the threshold.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_background</span><span class="p">(</span><span class="n">n_min</span><span class="o">=</span><span class="n">n_min</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="n">n_max</span><span class="p">,</span>
                            <span class="n">bkg_filter</span><span class="o">=</span><span class="n">bkg_filter</span><span class="p">,</span>
                            <span class="n">f_win</span><span class="o">=</span><span class="n">f_win</span><span class="p">,</span> <span class="n">f_n_lim</span><span class="o">=</span><span class="n">f_n_lim</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">lo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lo</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">hi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hi</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">lo</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">hi</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;calc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># create time points to calculate background</span>
            <span class="c1"># if cstep is None:</span>
                <span class="c1"># cstep = self.bkg[&#39;raw&#39;][&#39;uTime&#39;].ptp() / 100</span>
            <span class="c1"># bkg_t = np.arange(self.bkg[&#39;summary&#39;][&#39;uTime&#39;][&#39;mean&#39;].min(),</span>
            <span class="c1">#                   self.bkg[&#39;summary&#39;][&#39;uTime&#39;][&#39;mean&#39;].max(),</span>
            <span class="c1">#                   cstep)</span>

            <span class="n">bkg_t</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;uTime&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_time</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="s1">&#39;uTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_t</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Calculating Analyte Backgrounds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                                   <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                                   <span class="s1">&#39;stderr&#39;</span><span class="p">:</span> <span class="n">pad</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">]</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.bkg_subtract"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.bkg_subtract">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">bkg_subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errtype</span><span class="o">=</span><span class="s1">&#39;stderr&#39;</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="s1">&#39;despiked&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subtract calculated background from data.</span>

<span class="sd">        Must run bkg_calc first!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : str or iterable</span>
<span class="sd">            Which analyte(s) to subtract.</span>
<span class="sd">        errtype : str</span>
<span class="sd">            Which type of error to propagate. default is &#39;stderr&#39;.</span>
<span class="sd">        focus : str</span>
<span class="sd">            Which stage of analysis to work on. Change to &#39;rawdata&#39; if</span>
<span class="sd">            you&#39;re skipping the despiking step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="c1"># make uncertainty-aware background interpolators</span>
        <span class="n">bkg_interps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">:</span>
            <span class="n">bkg_interps</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">un_interp1d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="s1">&#39;uTime&#39;</span><span class="p">],</span>
                                         <span class="n">y</span><span class="o">=</span><span class="n">un</span><span class="o">.</span><span class="n">uarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">errtype</span><span class="p">]))</span>

        <span class="c1"># apply background corrections</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Background Subtraction&#39;</span><span class="p">):</span>
            <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">bkg_subtract</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">bkg_interps</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">uTime</span><span class="p">),</span> <span class="o">~</span><span class="n">d</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span> <span class="n">focus_stage</span><span class="o">=</span><span class="n">focus</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">]</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setfocus</span><span class="p">(</span><span class="s1">&#39;bkgsub&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span> <span class="o">=</span> <span class="s1">&#39;bkgsub&#39;</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.bkg_plot"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.bkg_plot">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">bkg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
                 <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="s1">&#39;stderr&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the calculated background.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : str or iterable</span>
<span class="sd">            Which analyte(s) to plot.</span>
<span class="sd">        figsize : tuple</span>
<span class="sd">            The (width, height) of the figure, in inches.</span>
<span class="sd">            If None, calculated based on number of samples.</span>
<span class="sd">        yscale : str</span>
<span class="sd">            &#39;log&#39; (default) or &#39;linear&#39;.</span>
<span class="sd">        ylim : tuple</span>
<span class="sd">            Manually specify the y scale.</span>
<span class="sd">        err : str</span>
<span class="sd">            What type of error to plot. Default is stderr.</span>
<span class="sd">        save : bool</span>
<span class="sd">            If True, figure is saved.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig, ax : matplotlib.figure, matplotlib.axes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;bkg&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Please calculate a background before attempting to</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;plot it... either:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;   bkg_calc_interp1d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;   bkg_calc_weightedmean</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mf">7.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="o">.</span><span class="mi">07</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">84</span><span class="p">,</span> <span class="o">.</span><span class="mi">8</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Plotting backgrounds&#39;</span><span class="p">,</span>
                      <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">analytes</span><span class="p">)):</span>
            <span class="c1"># draw data points</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">uTime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">a</span><span class="p">],</span>
                       <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
                       <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            
            <span class="c1"># draw STD boxes</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;uTime&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;uTime&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;uTime&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;uTime&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">yl</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">err</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="n">yu</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">err</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yl</span><span class="p">,</span> <span class="n">yu</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">yscale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]))</span>  <span class="c1"># x10 to make sample names readable.</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">:</span>
            <span class="c1"># draw confidence intervals of calculated</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="s1">&#39;uTime&#39;</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">err</span><span class="p">]</span>
            <span class="n">yu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;calc&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">err</span><span class="p">]</span>

            <span class="c1"># trim values below zero if log scale=    </span>
            <span class="k">if</span> <span class="n">yscale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="n">yl</span><span class="p">[</span><span class="n">yl</span> <span class="o">&lt;</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yl</span><span class="p">,</span> <span class="n">yu</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Background Counts&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Points = raw data; Bars = </span><span class="si">{:s}</span><span class="s1">; Lines = Calculated Background; Envelope = Background </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">err</span><span class="p">),</span>
                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">ha</span><span class="p">,</span> <span class="n">la</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">la</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">analytes</span><span class="p">)],</span> <span class="n">handles</span><span class="o">=</span><span class="n">ha</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">analytes</span><span class="p">)],</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># scale x axis to range  2.5%</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="n">rangecalc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][</span><span class="s1">&#39;uTime&#39;</span><span class="p">],</span> <span class="mf">0.025</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">uTime</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">uTime</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span> <span class="o">+</span> <span class="s1">&#39;/background.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

    <span class="c1"># functions for calculating ratios</span>
<div class="viewcode-block" id="analyse.ratio"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.ratio">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">internal_standard</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="s1">&#39;bkgsub&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the ratio of all analytes to a single analyte.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        internal_standard : str</span>
<span class="sd">            The name of the analyte to divide all other analytes</span>
<span class="sd">            by.</span>
<span class="sd">        focus : str</span>
<span class="sd">            The `focus` stage of the data used to calculating the</span>
<span class="sd">            ratios.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">internal_standard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span> <span class="o">=</span> <span class="n">internal_standard</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">internal_standard</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Ratio Calculation&#39;</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">internal_standard</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">,</span> <span class="n">focus</span><span class="o">=</span><span class="n">focus</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span> <span class="o">=</span> <span class="s1">&#39;ratios&#39;</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.srm_id_auto"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.srm_id_auto">[docs]</a>    <span class="k">def</span> <span class="nf">srm_id_auto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srms_used</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NIST610&#39;</span><span class="p">,</span> <span class="s1">&#39;NIST612&#39;</span><span class="p">,</span> <span class="s1">&#39;NIST614&#39;</span><span class="p">],</span> <span class="n">n_min</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for automarically identifying SRMs</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        srms_used : iterable</span>
<span class="sd">            Which SRMs have been used. Must match SRM names</span>
<span class="sd">            in SRM database *exactly* (case sensitive!).</span>
<span class="sd">        n_min : int</span>
<span class="sd">            The minimum number of data points a SRM measurement</span>
<span class="sd">            must contain to be included.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">srms_used</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">srms_used</span> <span class="o">=</span> <span class="p">[</span><span class="n">srms_used</span><span class="p">]</span>

        <span class="c1"># compile mean and standard errors of samples</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span><span class="p">:</span>
            <span class="n">stdtab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">analytes</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;err&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]]))</span>
            <span class="n">stdtab</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;uTime&#39;</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">ns</span> <span class="o">==</span> <span class="n">n</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n_min</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">analytes</span><span class="p">:</span>
                        <span class="n">aind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
                        <span class="n">stdtab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">uTime</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">ns</span> <span class="o">==</span> <span class="n">n</span><span class="p">]),</span>
                                   <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">aind</span><span class="p">])</span>
                        <span class="n">stdtab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">uTime</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">ns</span> <span class="o">==</span> <span class="n">n</span><span class="p">]),</span>
                                   <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;err&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">aind</span><span class="p">]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">aind</span><span class="p">))</span>

            <span class="c1"># sort column multiindex</span>
            <span class="n">stdtab</span> <span class="o">=</span> <span class="n">stdtab</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">stdtab</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()]</span>
            <span class="c1"># sort row index</span>
            <span class="n">stdtab</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># create &#39;SRM&#39; column for naming SRM</span>
            <span class="n">stdtab</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;SRM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">stdtab</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;STD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sample</span>

            <span class="n">s</span><span class="o">.</span><span class="n">stdtab</span> <span class="o">=</span> <span class="n">stdtab</span>

        <span class="n">stdtab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">stdtab</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;srmdat&#39;</span><span class="p">):</span>
            <span class="n">elnames</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.*([A-Z][a-z]{0,}).*&#39;</span><span class="p">)</span>  <span class="c1"># regex to ID element names</span>
            <span class="c1"># load SRM info</span>
            <span class="n">srmdat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srmfile</span><span class="p">)</span>
            <span class="n">srmdat</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;SRM&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">srmdat</span> <span class="o">=</span> <span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">srms_used</span><span class="p">]</span>

            <span class="c1"># get element name</span>
            <span class="n">internal_el</span> <span class="o">=</span> <span class="n">elnames</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># calculate ratios to internal_standard for all elements</span>
            <span class="k">for</span> <span class="n">srm</span> <span class="ow">in</span> <span class="n">srms_used</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">srmdat</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">srm</span>

                <span class="c1"># find denominator</span>
                <span class="n">denom</span> <span class="o">=</span> <span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">srmdat</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">internal_el</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ind</span><span class="p">]</span>
                <span class="c1"># calculate denominator composition (multiplier to account for stoichiometry,</span>
                <span class="c1"># e.g. if internal standard is Na, N will be 2 if measured in SRM as Na2O)</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;([A-Z][a-z]{0,})([0-9]{0,})&#39;</span><span class="p">,</span>
                                  <span class="n">denom</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># determine stoichiometric multiplier</span>
                <span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">comp</span> <span class="k">if</span> <span class="n">el</span> <span class="o">==</span> <span class="n">internal_el</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

                <span class="c1"># calculate molar ratio</span>
                <span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="s1">&#39;mol_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="s1">&#39;mol/g&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">denom</span><span class="p">[</span><span class="s1">&#39;mol/g&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
                <span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="s1">&#39;mol_ratio_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="s1">&#39;mol/g_err&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="s1">&#39;mol/g&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                                     <span class="p">(</span><span class="n">denom</span><span class="p">[</span><span class="s1">&#39;mol/g_err&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">denom</span><span class="p">[</span><span class="s1">&#39;mol/g&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span>
                                                    <span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="s1">&#39;mol_ratio&#39;</span><span class="p">])</span>  <span class="c1"># propagate uncertainty</span>

            <span class="c1"># isolate measured elements</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">elnames</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span><span class="p">])</span>
            <span class="n">srmdat</span> <span class="o">=</span> <span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">srmdat</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">any</span><span class="p">([</span><span class="n">a</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">]))]</span>
            <span class="c1"># label elements</span>
            <span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;element&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="n">elonly</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;([A-Z][a-z]{0,})&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="ow">in</span> <span class="n">elonly</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">srmdat</span><span class="o">.</span><span class="n">Item</span><span class="p">]</span>
                <span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="s1">&#39;element&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="c1"># convert to table in same format as stdtab</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">srmdat</span> <span class="o">=</span> <span class="n">srmdat</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">srm_tab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;mol_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;element&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;SRM&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;element&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;mol_ratio&#39;</span><span class="p">)</span>

        <span class="c1"># Auto - ID STDs</span>
        <span class="c1"># 1. identify elements in measured SRMS with biggest range of values</span>
        <span class="n">meas_tab</span> <span class="o">=</span> <span class="n">stdtab</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;mean&#39;</span><span class="p">)]</span>  <span class="c1"># isolate means of standards</span>
        <span class="n">meas_tab</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">meas_tab</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># drop &#39;mean&#39; column names</span>
        <span class="n">meas_tab</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;[A-Za-z]+&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">meas_tab</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>  <span class="c1"># rename to element names</span>
        <span class="n">meas_tab</span> <span class="o">=</span> <span class="n">meas_tab</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># remove duplicate columns</span>

        <span class="n">ranges</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">meas_tab</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># calculate relative ranges of all elements</span>
        <span class="c1"># (used as weights later)</span>

        <span class="c1"># 2. Work out which standard is which</span>
        <span class="c1"># normalise all elements between 0-1</span>
        <span class="k">def</span> <span class="nf">normalise</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">nmeas</span> <span class="o">=</span> <span class="n">meas_tab</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">normalise</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">nmeas</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nsrm_tab</span> <span class="o">=</span> <span class="n">srm_tab</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">normalise</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">nsrm_tab</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">uT</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">nmeas</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  <span class="c1"># for each standard...</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">nsrm_tab</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">ranges</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># calculate the absolute difference between the normalised elemental</span>
            <span class="c1"># values for each measured SRM and the SRM table. Each element is</span>
            <span class="c1"># multiplied by the relative range seen in that element (i.e. range / mean</span>
            <span class="c1"># measuerd value), so that elements with a large difference are given</span>
            <span class="c1"># more importance in identifying the SRM.</span>
            <span class="c1"># This produces a table, where wach row contains the difference between</span>
            <span class="c1"># a known vs. measured SRM. The measured SRM is identified as the SRM that</span>
            <span class="c1"># has the smallest weighted sum value.</span>
            <span class="n">stdtab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">uT</span><span class="p">,</span> <span class="s1">&#39;SRM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">srm_tab</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># calculate mean time for each SRM</span>
        <span class="c1"># reset index and sort</span>
        <span class="n">stdtab</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">stdtab</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># isolate STD and uTime</span>
        <span class="n">uT</span> <span class="o">=</span> <span class="n">stdtab</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;uTime&#39;</span><span class="p">,</span> <span class="s1">&#39;STD&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;STD&#39;</span><span class="p">)</span>
        <span class="n">uT</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">uTm</span> <span class="o">=</span> <span class="n">uT</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># mean uTime for each SRM</span>
        <span class="c1"># replace uTime values with means</span>
        <span class="n">stdtab</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;STD&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">stdtab</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;uTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uTm</span>
        <span class="c1"># reset index</span>
        <span class="n">stdtab</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">stdtab</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;STD&#39;</span><span class="p">,</span> <span class="s1">&#39;SRM&#39;</span><span class="p">,</span> <span class="s1">&#39;uTime&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># combine to make SRM reference tables</span>
        <span class="n">srmtabs</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span><span class="p">:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;[A-Za-z]+&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">sub</span> <span class="o">=</span> <span class="n">stdtab</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">a</span><span class="p">]</span>

            <span class="n">srmsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">srmdat</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">el</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mol_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;mol_ratio_err&#39;</span><span class="p">]]</span>

            <span class="n">srmtab</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">srmsub</span><span class="p">)</span>
            <span class="n">srmtab</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;meas_err&#39;</span><span class="p">,</span> <span class="s1">&#39;meas_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;srm_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;srm_err&#39;</span><span class="p">]</span>

            <span class="n">srmtabs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">srmtab</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">srmtabs</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">nominal_values</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.clear_calibration"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.clear_calibration">[docs]</a>    <span class="k">def</span> <span class="nf">clear_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">calib_fns</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">calib_ps</span></div>

    <span class="c1"># apply calibration to data</span>
<div class="viewcode-block" id="analyse.calibrate"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.calibrate">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drift_correct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">srms_used</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NIST610&#39;</span><span class="p">,</span> <span class="s1">&#39;NIST612&#39;</span><span class="p">,</span> <span class="s1">&#39;NIST614&#39;</span><span class="p">],</span>
                  <span class="n">zero_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_min</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calibrates the data to measured SRM values.</span>

<span class="sd">        Assumes that y intercept is zero.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : str or iterable</span>
<span class="sd">            Which analytes you&#39;d like to calibrate. Defaults to all.</span>
<span class="sd">        drift_correct : bool</span>
<span class="sd">            Whether to pool all SRM measurements into a single calibration,</span>
<span class="sd">            or vary the calibration through the run, interpolating</span>
<span class="sd">            coefficients between measured SRMs.</span>
<span class="sd">        srms_used : str or iterable</span>
<span class="sd">            Which SRMs have been measured. Must match names given in</span>
<span class="sd">            SRM data file *exactly*.</span>
<span class="sd">        n_min : int</span>
<span class="sd">            The minimum number of data points an SRM measurement</span>
<span class="sd">            must have to be included.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">analytes</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;srmtabs&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">srm_id_auto</span><span class="p">(</span><span class="n">srms_used</span><span class="p">,</span> <span class="n">n_min</span><span class="p">)</span>

        <span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># whether or not to pad with zero and max at end.</span>
        <span class="c1"># make container for calibration params</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;calib_params&#39;</span><span class="p">):</span>
            <span class="n">uTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;uTime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">analytes</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]]),</span>
                                             <span class="n">index</span><span class="o">=</span><span class="n">uTime</span><span class="p">)</span>
            <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zero_intercept</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">drop</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">drift_correct</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">meas</span> <span class="o">=</span> <span class="n">un</span><span class="o">.</span><span class="n">uarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span> <span class="s1">&#39;meas_mean&#39;</span><span class="p">],</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span> <span class="s1">&#39;meas_err&#39;</span><span class="p">])</span>
                            <span class="n">srm</span> <span class="o">=</span> <span class="n">un</span><span class="o">.</span><span class="n">uarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span> <span class="s1">&#39;srm_mean&#39;</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span> <span class="s1">&#39;srm_err&#39;</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">srm</span> <span class="o">/</span> <span class="n">meas</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="c1"># If the calibration is being recalculated, calib_params</span>
                            <span class="c1"># will have t=0 and t=max(uTime) values that are outside</span>
                            <span class="c1"># the srmtabs index.</span>
                            <span class="c1"># If this happens, drop them, and re-fill them at the end.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">meas</span> <span class="o">=</span> <span class="n">un</span><span class="o">.</span><span class="n">uarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;meas_mean&#39;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;meas_err&#39;</span><span class="p">])</span>
                    <span class="n">srm</span> <span class="o">=</span> <span class="n">un</span><span class="o">.</span><span class="n">uarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;srm_mean&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;srm_err&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">srm</span> <span class="o">/</span> <span class="n">meas</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">drift_correct</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span> <span class="s1">&#39;meas_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span> <span class="s1">&#39;srm_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

                            <span class="c1"># TODO : error estimation in drift corrected non-zero-intercept</span>
                            <span class="c1"># case. Tricky because np.polyfit will only return cov</span>
                            <span class="c1"># if n samples &gt; order + 2 (rare, for laser ablation).</span>
                            <span class="c1">#</span>
                            <span class="c1"># First attempt (doesn&#39;t work):</span>
                            <span class="c1">#</span>
                            <span class="c1"># p, cov = np.polyfit(x, y, 1, w=errs, cov=True)</span>
                            <span class="c1"># ferr = np.sqrt(np.diag(cov))</span>
                            <span class="c1"># pe = un.uarray(p, ferr)</span>
                            <span class="c1"># pe = np.polyfit(x, y, 1, w=errs)</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">m</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>
                                <span class="n">c</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">m</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span>
                                <span class="n">c</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="k">def</span> <span class="nf">lin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
                                    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="n">c</span>
                                <span class="n">p</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">lin</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                                <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
                                <span class="n">m</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">c</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">err</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">m</span>  <span class="c1"># pe[0]</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">c</span>  <span class="c1"># pe[1]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="c1"># If the calibration is being recalculated, calib_params</span>
                            <span class="c1"># will have t=0 and t=max(uTime) values that are outside</span>
                            <span class="c1"># the srmtabs index and can&#39;t be interpolated.</span>
                            <span class="c1"># If this happens, drop them, and re-fill them at the end.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="s1">&#39;meas_mean&#39;</span><span class="p">]</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="s1">&#39;srm_mean&#39;</span><span class="p">]</span>
                    <span class="n">errs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="s1">&#39;meas_err&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">srmtabs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="s1">&#39;srm_err&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="n">p</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">errs</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ferr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
                    <span class="n">pe</span> <span class="o">=</span> <span class="n">un</span><span class="o">.</span><span class="n">uarray</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ferr</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">fill</span><span class="p">:</span>
            <span class="c1"># fill in uTime=0 and uTime = max cases for interpolation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="p">:]</span>
            <span class="n">maxuT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">uTime</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>  <span class="c1"># calculate max uTime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">maxuT</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="p">:]</span>
        <span class="c1"># sort indices for slice access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># calculcate interpolators for applying calibrations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calib_ps</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calib_ps</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">un_interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="p">)}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">zero_intercept</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calib_ps</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">un_interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">calib_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Applying Calibrations&#39;</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calib_ps</span><span class="p">,</span> <span class="n">analytes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span> <span class="o">=</span> <span class="s1">&#39;calibrated&#39;</span>

        <span class="k">return</span></div>

    <span class="c1"># data filtering</span>
    <span class="c1"># TODO: Re-factor filtering to use &#39;classifier&#39; objects?</span>

<div class="viewcode-block" id="analyse.make_subset"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.make_subset">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">make_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a subset of samples, which can be treated independently.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        samples : str or array - like</span>
<span class="sd">            Name of sample, or list of sample names.</span>
<span class="sd">        name : (optional) str or number</span>
<span class="sd">            The name of the sample group. Defaults to n + 1, where n is</span>
<span class="sd">            the highest existing group number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">samples</span><span class="p">]</span>

        <span class="n">not_exists</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;All_Analyses&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_exists</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">not_exists</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; not in the list of sample names.</span><span class="se">\n</span><span class="s1">Please check your sample names.</span><span class="se">\n</span><span class="s1">Note: Sample names are stored in the .samples attribute of your analysis.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">)])</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_subset_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;not_in_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_has_subsets</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># for subset in np.unique(list(self.subsets.values())):</span>
        <span class="c1">#     self.subsets[subset] = sorted([k for k, v in self.subsets.items() if str(v) == subset])</span>

        <span class="k">return</span> <span class="n">name</span></div>

<div class="viewcode-block" id="analyse.zeroscreen"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.zeroscreen">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">zeroscreen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focus_stage</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all points containing data below zero (which are impossible!)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">focus_stage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">focus_stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">Time</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">focus_stage</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">focus_stage</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">focus_stage</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="o">~</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">ufloat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_focus</span><span class="p">(</span><span class="n">focus_stage</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.filter_threshold"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_threshold">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyte</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
                         <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a threshold filter to the data.</span>

<span class="sd">        Generates two filters above and below the threshold value for a</span>
<span class="sd">        given analyte.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analyte : str</span>
<span class="sd">            The analyte that the filter applies to.</span>
<span class="sd">        threshold : float</span>
<span class="sd">            The threshold value.</span>
<span class="sd">        filt : bool</span>
<span class="sd">            Whether or not to apply existing filters to the data before</span>
<span class="sd">            calculating this filter.</span>
<span class="sd">        samples : array_like or None</span>
<span class="sd">            Which samples to apply this filter to. If None, applies to all</span>
<span class="sd">            samples.</span>
<span class="sd">        subset : str or number</span>
<span class="sd">            The subset of samples (defined by make_subset) you want to apply</span>
<span class="sd">            the filter to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">analyte</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Threshold Filter&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filter_threshold</span><span class="p">(</span><span class="n">analyte</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span></div>

<div class="viewcode-block" id="analyse.filter_threshold_percentile"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_threshold_percentile">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_threshold_percentile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyte</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a threshold filter to the data.</span>

<span class="sd">        Generates two filters above and below the threshold value for a</span>
<span class="sd">        given analyte.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analyte : str</span>
<span class="sd">            The analyte that the filter applies to.</span>
<span class="sd">        percentiles : float or iterable of len=2</span>
<span class="sd">            The percentile values.</span>
<span class="sd">        level : str</span>
<span class="sd">            Whether to calculate percentiles from the entire dataset</span>
<span class="sd">            (&#39;population&#39;) or for each individual sample (&#39;individual&#39;)</span>
<span class="sd">        filt : bool</span>
<span class="sd">            Whether or not to apply existing filters to the data before</span>
<span class="sd">            calculating this filter.</span>
<span class="sd">        samples : array_like or None</span>
<span class="sd">            Which samples to apply this filter to. If None, applies to all</span>
<span class="sd">            samples.</span>
<span class="sd">        subset : str or number</span>
<span class="sd">            The subset of samples (defined by make_subset) you want to apply</span>
<span class="sd">            the filter to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">analyte</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentiles</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">percentiles</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;population&#39;</span><span class="p">:</span>
            <span class="c1"># Get all samples</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span> <span class="n">nominal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="n">analyte</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="n">analyte</span><span class="p">])]</span>

            <span class="c1"># calculate filter limits</span>
            <span class="n">lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span>

        <span class="c1"># Calculate filter for individual samples</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Percentile theshold filter&#39;</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">setn</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">maxset</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="n">analyte</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;individual&#39;</span><span class="p">:</span>
                <span class="n">gt</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="n">lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">gt</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">gt</span><span class="p">)],</span> <span class="n">percentiles</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">above</span> <span class="o">=</span> <span class="n">g</span> <span class="o">&gt;=</span> <span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">below</span> <span class="o">=</span> <span class="n">g</span> <span class="o">&lt;</span> <span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">d</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">{:.1f}</span><span class="s1">-pcnt_below&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                           <span class="n">below</span><span class="p">,</span>
                           <span class="s1">&#39;Values below </span><span class="si">{:.1f}</span><span class="s1">th &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;percentile&#39;</span><span class="p">,</span>
                           <span class="n">params</span><span class="p">,</span> <span class="n">setn</span><span class="o">=</span><span class="n">setn</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">{:.1f}</span><span class="s1">-pcnt_above&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                           <span class="n">above</span><span class="p">,</span>
                           <span class="s1">&#39;Values above </span><span class="si">{:.1f}</span><span class="s1">th &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;percentile&#39;</span><span class="p">,</span>
                           <span class="n">params</span><span class="p">,</span> <span class="n">setn</span><span class="o">=</span><span class="n">setn</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">inside</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lims</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lims</span><span class="p">))</span>
                <span class="n">outside</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">lims</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">lims</span><span class="p">))</span>

                <span class="n">lpc</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">])</span>
                <span class="n">d</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">lpc</span> <span class="o">+</span> <span class="s1">&#39;-pcnt_inside&#39;</span><span class="p">,</span>
                           <span class="n">inside</span><span class="p">,</span>
                           <span class="s1">&#39;Values between &#39;</span> <span class="o">+</span> <span class="n">lpc</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;percentiles&#39;</span><span class="p">,</span>
                           <span class="n">params</span><span class="p">,</span> <span class="n">setn</span><span class="o">=</span><span class="n">setn</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">lpc</span> <span class="o">+</span> <span class="s1">&#39;-pcnt_outside&#39;</span><span class="p">,</span>
                           <span class="n">outside</span><span class="p">,</span>
                           <span class="s1">&#39;Values outside &#39;</span> <span class="o">+</span> <span class="n">lpc</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;percentiles&#39;</span><span class="p">,</span>
                           <span class="n">params</span><span class="p">,</span> <span class="n">setn</span><span class="o">=</span><span class="n">setn</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="analyse.filter_gradient_threshold"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_gradient_threshold">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_gradient_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyte</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                  <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate a gradient threshold filter to the data.</span>

<span class="sd">        Generates two filters above and below the threshold value for a</span>
<span class="sd">        given analyte.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analyte : str</span>
<span class="sd">            The analyte that the filter applies to.</span>
<span class="sd">        win : int</span>
<span class="sd">            The window over which to calculate the moving gradient</span>
<span class="sd">        threshold : float</span>
<span class="sd">            The threshold value.</span>
<span class="sd">        filt : bool</span>
<span class="sd">            Whether or not to apply existing filters to the data before</span>
<span class="sd">            calculating this filter.</span>
<span class="sd">        samples : array_like or None</span>
<span class="sd">            Which samples to apply this filter to. If None, applies to all</span>
<span class="sd">            samples.</span>
<span class="sd">        subset : str or number</span>
<span class="sd">            The subset of samples (defined by make_subset) you want to apply</span>
<span class="sd">            the filter to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">analyte</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Threshold Filter&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filter_gradient_threshold</span><span class="p">(</span><span class="n">analyte</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span></div>

<div class="viewcode-block" id="analyse.filter_gradient_threshold_percentile"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_gradient_threshold_percentile">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_gradient_threshold_percentile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyte</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                             <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate a gradient threshold filter to the data.</span>

<span class="sd">        Generates two filters above and below the threshold value for a</span>
<span class="sd">        given analyte.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analyte : str</span>
<span class="sd">            The analyte that the filter applies to.</span>
<span class="sd">        win : int</span>
<span class="sd">            The window over which to calculate the moving gradient</span>
<span class="sd">        percentiles : float or iterable of len=2</span>
<span class="sd">            The percentile values.</span>
<span class="sd">        filt : bool</span>
<span class="sd">            Whether or not to apply existing filters to the data before</span>
<span class="sd">            calculating this filter.</span>
<span class="sd">        samples : array_like or None</span>
<span class="sd">            Which samples to apply this filter to. If None, applies to all</span>
<span class="sd">            samples.</span>
<span class="sd">        subset : str or number</span>
<span class="sd">            The subset of samples (defined by make_subset) you want to apply</span>
<span class="sd">            the filter to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">analyte</span><span class="p">])</span>

        <span class="c1"># Calculate gradients of all samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_gradients</span><span class="p">(</span><span class="n">analytes</span><span class="o">=</span><span class="p">[</span><span class="n">analyte</span><span class="p">],</span> <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">)</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">analyte</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">analyte</span><span class="p">])]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentiles</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">percentiles</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;population&#39;</span><span class="p">:</span>
            <span class="c1"># calculate filter limits</span>
            <span class="n">lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span>

        <span class="c1"># Calculate filter for individual samples</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Percentile theshold filter&#39;</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">setn</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">maxset</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">calc_grads</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Time</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">focus</span><span class="p">,</span> <span class="p">[</span><span class="n">analyte</span><span class="p">],</span> <span class="n">win</span><span class="p">)[</span><span class="n">analyte</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;individual&#39;</span><span class="p">:</span>
                <span class="n">gt</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="n">lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">gt</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">gt</span><span class="p">)],</span> <span class="n">percentiles</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">above</span> <span class="o">=</span> <span class="n">g</span> <span class="o">&gt;=</span> <span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">below</span> <span class="o">=</span> <span class="n">g</span> <span class="o">&lt;</span> <span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">d</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">{:.1f}</span><span class="s1">-grd-pcnt_below&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                           <span class="n">below</span><span class="p">,</span>
                           <span class="s1">&#39;Gradients below </span><span class="si">{:.1f}</span><span class="s1">th &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;percentile&#39;</span><span class="p">,</span>
                           <span class="n">params</span><span class="p">,</span> <span class="n">setn</span><span class="o">=</span><span class="n">setn</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">{:.1f}</span><span class="s1">-grd-pcnt_above&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                           <span class="n">above</span><span class="p">,</span>
                           <span class="s1">&#39;Gradients above </span><span class="si">{:.1f}</span><span class="s1">th &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;percentile&#39;</span><span class="p">,</span>
                           <span class="n">params</span><span class="p">,</span> <span class="n">setn</span><span class="o">=</span><span class="n">setn</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">inside</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lims</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lims</span><span class="p">))</span>
                <span class="n">outside</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">lims</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">lims</span><span class="p">))</span>

                <span class="n">lpc</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">])</span>
                <span class="n">d</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">lpc</span> <span class="o">+</span> <span class="s1">&#39;-grd-pcnt_inside&#39;</span><span class="p">,</span>
                           <span class="n">inside</span><span class="p">,</span>
                           <span class="s1">&#39;Gradients between &#39;</span> <span class="o">+</span> <span class="n">lpc</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;percentiles&#39;</span><span class="p">,</span>
                           <span class="n">params</span><span class="p">,</span> <span class="n">setn</span><span class="o">=</span><span class="n">setn</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">lpc</span> <span class="o">+</span> <span class="s1">&#39;-grd-pcnt_outside&#39;</span><span class="p">,</span>
                           <span class="n">outside</span><span class="p">,</span>
                           <span class="s1">&#39;Gradients outside &#39;</span> <span class="o">+</span> <span class="n">lpc</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">analyte</span> <span class="o">+</span> <span class="s1">&#39;percentiles&#39;</span><span class="p">,</span>
                           <span class="n">params</span><span class="p">,</span> <span class="n">setn</span><span class="o">=</span><span class="n">setn</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="c1"># @_log</span>
    <span class="c1"># def filter_inclusion_excluder(self, analytes, gwin=5, swin=None, win=10, log=False,</span>
    <span class="c1">#                               on_mult=(1., 1.), off_mult=(1., 1.), nbin=5,</span>
    <span class="c1">#                               filt=False, samples=None, subset=None):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Find inclusions in profile based on specific analytes.</span>

    <span class="c1">#     Identifies anomalously high / low regions of a specific analyte or analytes</span>
    <span class="c1">#     and returns two filters of the &#39;low&#39; and &#39;high&#39; regions, excluding the</span>
    <span class="c1">#     the transition between them.</span>

    <span class="c1">#     The mechanics of the filter is identical to the `autorange` function.</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     analytes : str or list</span>
    <span class="c1">#         Which analytes to use to identify inclusions.</span>
    <span class="c1">#     gwin : int</span>
    <span class="c1">#         The size of the window used for smoothing and calculating the derivative.</span>
    <span class="c1">#     win : int</span>
    <span class="c1">#         The region either side of lo-hi transitions to consider for exclusion.</span>
    <span class="c1">#     log : bool</span>
    <span class="c1">#         Whether or not to log-transform the data</span>
    <span class="c1">#     on_mult, off_mult : tuple</span>
    <span class="c1">#         The width (multiples of FWHM) either side of identified matierla transitions to exclude.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if isinstance(analytes, str):</span>
    <span class="c1">#         analytes = [analytes]</span>

    <span class="c1">#     if samples is not None:</span>
    <span class="c1">#         subset = self.make_subset(samples)</span>

    <span class="c1">#     samples = self._get_samples(subset)</span>

    <span class="c1">#     self.minimal_analytes.update(analytes)</span>

    <span class="c1">#     for s in tqdm(samples, desc=&#39;Finding Inclusions&#39;):</span>
    <span class="c1">#         self.data[s].filter_inclusion_excluder(analytes, gwin=gwin, swin=swin, win=win, log=log,</span>
    <span class="c1">#                                                on_mult=on_mult, off_mult=off_mult,</span>
    <span class="c1">#                                                filt=filt, nbin=nbin)</span>
    <span class="c1">#     return</span>

    <span class="c1"># @_log</span>
    <span class="c1"># def filter_distribution(self, analyte, binwidth=&#39;scott&#39;, filt=False,</span>
    <span class="c1">#                         transform=None, samples=None, subset=None,</span>
    <span class="c1">#                         min_data=10):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Applies a distribution filter to the data.</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     analyte : str</span>
    <span class="c1">#         The analyte that the filter applies to.</span>
    <span class="c1">#     binwidth : str of float</span>
    <span class="c1">#         Specify the bin width of the kernel density estimator.</span>
    <span class="c1">#         Passed to `scipy.stats.gaussian_kde`.</span>
    <span class="c1">#         If &#39;scott&#39; or &#39;silverman&#39;, the method used to automatically </span>
    <span class="c1">#         estimate bin width. If float, it manually sets the binwidth.</span>
    <span class="c1">#     filt : bool</span>
    <span class="c1">#         Whether or not to apply existing filters to the data before</span>
    <span class="c1">#         calculating this filter.</span>
    <span class="c1">#     transform : str</span>
    <span class="c1">#         If &#39;log&#39;, applies a log transform to the data before calculating</span>
    <span class="c1">#         the distribution.</span>
    <span class="c1">#     samples : array_like or None</span>
    <span class="c1">#         Which samples to apply this filter to. If None, applies to all</span>
    <span class="c1">#         samples.</span>
    <span class="c1">#     min_data : int</span>
    <span class="c1">#         The minimum number of data points that should be considered by</span>
    <span class="c1">#         the filter. Default = 10.</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     None</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if samples is not None:</span>
    <span class="c1">#         subset = self.make_subset(samples)</span>

    <span class="c1">#     samples = self._get_samples(subset)</span>

    <span class="c1">#     self.minimal_analytes.update([analyte])</span>

    <span class="c1">#     for s in tqdm(samples, desc=&#39;Distribution Filter&#39;):</span>
    <span class="c1">#         self.data[s].filter_distribution(analyte, binwidth=&#39;scott&#39;,</span>
    <span class="c1">#                                          filt=filt, transform=None,</span>
    <span class="c1">#                                          min_data=min_data)</span>

<div class="viewcode-block" id="analyse.filter_clustering"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_clustering">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">method</span><span class="o">=</span><span class="s1">&#39;meanshift&#39;</span><span class="p">,</span> <span class="n">include_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_data</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies an n - dimensional clustering filter to the data.</span>
<span class="sd">     </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : str</span>
<span class="sd">            The analyte(s) that the filter applies to.</span>
<span class="sd">        filt : bool</span>
<span class="sd">            Whether or not to apply existing filters to the data before</span>
<span class="sd">            calculating this filter.</span>
<span class="sd">        normalise : bool</span>
<span class="sd">            Whether or not to normalise the data to zero mean and unit</span>
<span class="sd">            variance. Reccomended if clustering based on more than 1 analyte.</span>
<span class="sd">            Uses `sklearn.preprocessing.scale`.</span>
<span class="sd">        method : str</span>
<span class="sd">            Which clustering algorithm to use:</span>
<span class="sd">            </span>
<span class="sd">            * &#39;meanshift&#39;: The `sklearn.cluster.MeanShift` algorithm.</span>
<span class="sd">              Automatically determines number of clusters</span>
<span class="sd">              in data based on the `bandwidth` of expected</span>
<span class="sd">              variation.</span>
<span class="sd">            * &#39;kmeans&#39;: The `sklearn.cluster.KMeans` algorithm. Determines</span>
<span class="sd">              the characteristics of a known number of clusters</span>
<span class="sd">              within the data. Must provide `n_clusters` to specify</span>
<span class="sd">              the expected number of clusters.</span>
<span class="sd">            * &#39;DBSCAN&#39;: The `sklearn.cluster.DBSCAN` algorithm. Automatically</span>
<span class="sd">              determines the number and characteristics of clusters</span>
<span class="sd">              within the data based on the &#39;connectivity&#39; of the</span>
<span class="sd">              data (i.e. how far apart each data point is in a</span>
<span class="sd">              multi - dimensional parameter space). Requires you to</span>
<span class="sd">              set `eps`, the minimum distance point must be from</span>
<span class="sd">              another point to be considered in the same cluster,</span>
<span class="sd">              and `min_samples`, the minimum number of points that</span>
<span class="sd">              must be within the minimum distance for it to be</span>
<span class="sd">              considered a cluster. It may also be run in automatic</span>
<span class="sd">              mode by specifying `n_clusters` alongside</span>
<span class="sd">              `min_samples`, where eps is decreased until the</span>
<span class="sd">              desired number of clusters is obtained.</span>

<span class="sd">        include_time : bool</span>
<span class="sd">            Whether or not to include the Time variable in the clustering</span>
<span class="sd">            analysis. Useful if you&#39;re looking for spatially continuous</span>
<span class="sd">            clusters in your data, i.e. this will identify each spot in your</span>
<span class="sd">            analysis as an individual cluster.</span>
<span class="sd">        samples : optional, array_like or None</span>
<span class="sd">            Which samples to apply this filter to. If None, applies to all</span>
<span class="sd">            samples.</span>
<span class="sd">        sort : bool</span>
<span class="sd">            Whether or not you want the cluster labels to</span>
<span class="sd">            be sorted by the mean magnitude of the signals</span>
<span class="sd">            they are based on (0 = lowest)</span>
<span class="sd">        min_data : int</span>
<span class="sd">            The minimum number of data points that should be considered by</span>
<span class="sd">            the filter. Default = 10.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Parameters passed to the clustering algorithm specified by</span>
<span class="sd">            `method`.</span>
<span class="sd">        Meanshift Parameters</span>
<span class="sd">            bandwidth : str or float</span>
<span class="sd">                The bandwith (float) or bandwidth method (&#39;scott&#39; or &#39;silverman&#39;)</span>
<span class="sd">                used to estimate the data bandwidth.</span>
<span class="sd">            bin_seeding : bool</span>
<span class="sd">                Modifies the behaviour of the meanshift algorithm. Refer to</span>
<span class="sd">                sklearn.cluster.meanshift documentation.</span>
<span class="sd">        K - Means Parameters</span>
<span class="sd">            n_clusters : int</span>
<span class="sd">                The number of clusters expected in the data.</span>
<span class="sd">        DBSCAN Parameters</span>
<span class="sd">            eps : float</span>
<span class="sd">                The minimum &#39;distance&#39; points must be apart for them to be in the</span>
<span class="sd">                same cluster. Defaults to 0.3. Note: If the data are normalised</span>
<span class="sd">                (they should be for DBSCAN) this is in terms of total sample</span>
<span class="sd">                variance. Normalised data have a mean of 0 and a variance of 1.</span>
<span class="sd">            min_samples : int</span>
<span class="sd">                The minimum number of samples within distance `eps` required</span>
<span class="sd">                to be considered as an independent cluster.</span>
<span class="sd">            n_clusters : int</span>
<span class="sd">                The number of clusters expected. If specified, `eps` will be</span>
<span class="sd">                incrementally reduced until the expected number of clusters is</span>
<span class="sd">                found.</span>
<span class="sd">            maxiter : int</span>
<span class="sd">                The maximum number of iterations DBSCAN will run.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">analytes</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Clustering Filter&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filter_clustering</span><span class="p">(</span><span class="n">analytes</span><span class="o">=</span><span class="n">analytes</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span>
                                           <span class="n">normalise</span><span class="o">=</span><span class="n">normalise</span><span class="p">,</span>
                                           <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                           <span class="n">include_time</span><span class="o">=</span><span class="n">include_time</span><span class="p">,</span>
                                           <span class="n">min_data</span><span class="o">=</span><span class="n">min_data</span><span class="p">,</span>
                                           <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="analyse.filter_correlation"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_correlation">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_analyte</span><span class="p">,</span> <span class="n">y_analyte</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">r_threshold</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">p_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a correlation filter to the data.</span>

<span class="sd">        Calculates a rolling correlation between every `window` points of</span>
<span class="sd">        two analytes, and excludes data where their Pearson&#39;s R value is</span>
<span class="sd">        above `r_threshold` and statistically significant.</span>

<span class="sd">        Data will be excluded where their absolute R value is greater than</span>
<span class="sd">        `r_threshold` AND the p - value associated with the correlation is</span>
<span class="sd">        less than `p_threshold`. i.e. only correlations that are statistically</span>
<span class="sd">        significant are considered.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_analyte, y_analyte : str</span>
<span class="sd">            The names of the x and y analytes to correlate.</span>
<span class="sd">        window : int, None</span>
<span class="sd">            The rolling window used when calculating the correlation.</span>
<span class="sd">        r_threshold : float</span>
<span class="sd">            The correlation index above which to exclude data.</span>
<span class="sd">            Note: the absolute pearson R value is considered, so</span>
<span class="sd">            negative correlations below -`r_threshold` will also</span>
<span class="sd">            be excluded.</span>
<span class="sd">        p_threshold : float</span>
<span class="sd">            The significant level below which data are excluded.</span>
<span class="sd">        filt : bool</span>
<span class="sd">            Whether or not to apply existing filters to the data before</span>
<span class="sd">            calculating this filter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">x_analyte</span><span class="p">,</span> <span class="n">y_analyte</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Correlation Filter&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filter_correlation</span><span class="p">(</span><span class="n">x_analyte</span><span class="p">,</span> <span class="n">y_analyte</span><span class="p">,</span>
                                            <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
                                            <span class="n">r_threshold</span><span class="o">=</span><span class="n">r_threshold</span><span class="p">,</span>
                                            <span class="n">p_threshold</span><span class="o">=</span><span class="n">p_threshold</span><span class="p">,</span>
                                            <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">)</span></div>

<div class="viewcode-block" id="analyse.filter_on"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_on">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analyte</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_status</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns data filters on for particular analytes and samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filt : optional, str or array_like</span>
<span class="sd">            Name, partial name or list of names of filters. Supports</span>
<span class="sd">            partial matching. i.e. if &#39;cluster&#39; is specified, all</span>
<span class="sd">            filters with &#39;cluster&#39; in the name are activated.</span>
<span class="sd">            Defaults to all filters.</span>
<span class="sd">        analyte : optional, str or array_like</span>
<span class="sd">            Name or list of names of analytes. Defaults to all analytes.</span>
<span class="sd">        samples : optional, array_like or None</span>
<span class="sd">            Which samples to apply this filter to. If None, applies to all</span>
<span class="sd">            samples.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">analyte</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;filt.on failure in sample &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_status</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.filter_off"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_off">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analyte</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_status</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns data filters off for particular analytes and samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filt : optional, str or array_like</span>
<span class="sd">            Name, partial name or list of names of filters. Supports</span>
<span class="sd">            partial matching. i.e. if &#39;cluster&#39; is specified, all</span>
<span class="sd">            filters with &#39;cluster&#39; in the name are activated.</span>
<span class="sd">            Defaults to all filters.</span>
<span class="sd">        analyte : optional, str or array_like</span>
<span class="sd">            Name or list of names of analytes. Defaults to all analytes.</span>
<span class="sd">        samples : optional, array_like or None</span>
<span class="sd">            Which samples to apply this filter to. If None, applies to all</span>
<span class="sd">            samples.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">off</span><span class="p">(</span><span class="n">analyte</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;filt.off failure in sample &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_status</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="c1"># @_log</span>
    <span class="c1"># def filter_combine(self, name, filt_str, samples=None, subset=None):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Make new filter from combination of other filters.</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     name : str</span>
    <span class="c1">#         The name of the new filter. Should be unique.</span>
    <span class="c1">#     filt_str : str</span>
    <span class="c1">#         A logical combination of partial strings which will create</span>
    <span class="c1">#         the new filter. For example, &#39;Albelow &amp; Mnbelow&#39; will combine</span>
    <span class="c1">#         all filters that partially match &#39;Albelow&#39; with those that</span>
    <span class="c1">#         partially match &#39;Mnbelow&#39; using the &#39;AND&#39; logical operator.</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     None</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if samples is not None:</span>
    <span class="c1">#         subset = self.make_subset(samples)</span>

    <span class="c1">#     samples = self._get_samples(subset)</span>

    <span class="c1">#     for s in tqdm(samples, desc=&#39;Threshold Filter&#39;):</span>
    <span class="c1">#         self.data[s].filt.filter_new(name, filter_string)</span>

<div class="viewcode-block" id="analyse.filter_status"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_status">[docs]</a>    <span class="k">def</span> <span class="nf">filter_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints the current status of filters for specified samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample : str</span>
<span class="sd">            Which sample to print.</span>
<span class="sd">        subset : str</span>
<span class="sd">            Specify a subset</span>
<span class="sd">        stds : bool</span>
<span class="sd">            Whether or not to include standards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">subset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_subsets</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Subset: All Samples</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;All_Samples&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subset_names</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Subset: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Samples: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;not_in_set&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Not in Subset:</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Samples: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;not_in_set&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;not_in_set&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Sample: &#39;</span> <span class="o">+</span> <span class="n">sample</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="n">subset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">subset</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Subset: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Samples: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.filter_clear"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_clear">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears (deletes) all data filters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="analyse.filter_defragment"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_defragment">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_defragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;include&#39;</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove &#39;fragments&#39; from the calculated filter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">grab_filt</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;defrag_</span><span class="si">{:s}</span><span class="s1">_</span><span class="si">{:.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">threshold</span><span class="p">),</span>
                                  <span class="n">filt</span><span class="o">=</span><span class="n">filters</span><span class="o">.</span><span class="n">defrag</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">mode</span><span class="p">),</span>
                                  <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Defrag </span><span class="si">{:s}</span><span class="s1"> filter with threshold </span><span class="si">{:.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">threshold</span><span class="p">),</span>
                                  <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">subset</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="analyse.filter_exclude_downhole"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_exclude_downhole">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_exclude_downhole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exclude all points down-hole (after) the first excluded data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        threhold : int</span>
<span class="sd">            The minimum number of contiguous excluded data points</span>
<span class="sd">            that must exist before downhole exclusion occurs.</span>
<span class="sd">        file : valid filter string or bool</span>
<span class="sd">            Which filter to consider. If True, applies to currently active</span>
<span class="sd">            filters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filter_exclude_downhole</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span></div>

<div class="viewcode-block" id="analyse.filter_trim"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_trim">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_trim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove points from the start and end of filter regions.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start, end : int</span>
<span class="sd">            The number of points to remove from the start and end of</span>
<span class="sd">            the specified filter.</span>
<span class="sd">        filt : valid filter string or bool</span>
<span class="sd">            Which filter to trim. If True, applies to currently active</span>
<span class="sd">            filters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filter_trim</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span></div>

<div class="viewcode-block" id="analyse.filter_nremoved"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_nremoved">[docs]</a>    <span class="k">def</span> <span class="nf">filter_nremoved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Report how many data are removed by the active filters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rminfo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;All_Samples&#39;</span><span class="p">]:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">rminfo</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">filt_nremoved</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">maxL</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">rminfo</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;{string:</span><span class="si">{number}</span><span class="s1">s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Sample &#39;</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">maxL</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
                  <span class="s1">&#39;</span><span class="si">{total:4s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="s1">&#39;tot&#39;</span><span class="p">)</span> <span class="o">+</span>
                  <span class="s1">&#39;</span><span class="si">{removed:4s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">removed</span><span class="o">=</span><span class="s1">&#39;flt&#39;</span><span class="p">)</span> <span class="o">+</span>
                  <span class="s1">&#39;</span><span class="si">{percent:4s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">m&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">ntot</span><span class="p">,</span> <span class="n">nfilt</span><span class="p">,</span> <span class="n">pcrm</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rminfo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;{string:</span><span class="si">{number}</span><span class="s1">s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">maxL</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
                      <span class="s1">&#39;</span><span class="si">{total:4.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">ntot</span><span class="p">)</span> <span class="o">+</span>
                      <span class="s1">&#39;</span><span class="si">{removed:4.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">removed</span><span class="o">=</span><span class="n">nfilt</span><span class="p">)</span> <span class="o">+</span>
                      <span class="s1">&#39;</span><span class="si">{percent:4.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent</span><span class="o">=</span><span class="n">pcrm</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">rminfo</span></div>
    
<div class="viewcode-block" id="analyse.optimise_signal"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.optimise_signal">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">optimise_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="p">,</span> <span class="n">min_points</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">threshold_mode</span><span class="o">=</span><span class="s1">&#39;kde_first_max&#39;</span><span class="p">,</span> 
                        <span class="n">threshold_mult</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">x_bias</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimise data selection based on specified analytes.</span>

<span class="sd">        Identifies the longest possible contiguous data region in</span>
<span class="sd">        the signal where the relative standard deviation (std) and </span>
<span class="sd">        concentration of all analytes is minimised.</span>

<span class="sd">        Optimisation is performed via a grid search of all possible</span>
<span class="sd">        contiguous data regions. For each region, the mean std and</span>
<span class="sd">        mean scaled analyte concentration (&#39;amplitude&#39;) are calculated. </span>
<span class="sd">        </span>
<span class="sd">        The size and position of the optimal data region are identified </span>
<span class="sd">        using threshold std and amplitude values. Thresholds are derived</span>
<span class="sd">        from all calculated stds and amplitudes using the method specified</span>
<span class="sd">        by `threshold_mode`. For example, using the &#39;kde_max&#39; method, a</span>
<span class="sd">        probability density function (PDF) is calculated for std and</span>
<span class="sd">        amplitude values, and the threshold is set as the maximum of the</span>
<span class="sd">        PDF. These thresholds are then used to identify the size and position</span>
<span class="sd">        of the longest contiguous region where the std is below the threshold, </span>
<span class="sd">        and the amplitude is either below the threshold.</span>

<span class="sd">        All possible regions of the data that have at least</span>
<span class="sd">        `min_points` are considered.</span>

<span class="sd">        For a graphical demonstration of the action of signal_optimiser, </span>
<span class="sd">        use `optimisation_plot`. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : latools.D object</span>
<span class="sd">            An latools data object.</span>
<span class="sd">        analytes : str or array-like</span>
<span class="sd">            Which analytes to consider.</span>
<span class="sd">        min_points : int</span>
<span class="sd">            The minimum number of contiguous points to</span>
<span class="sd">            consider.</span>
<span class="sd">        threshold_mode : str</span>
<span class="sd">            The method used to calculate the optimisation</span>
<span class="sd">            thresholds. Can be &#39;mean&#39;, &#39;median&#39;, &#39;kde_max&#39;</span>
<span class="sd">            or &#39;bayes_mvs&#39;, or a custom function. If a</span>
<span class="sd">            function, must take a 1D array, and return a</span>
<span class="sd">            single, real number.</span>
<span class="sd">        weights : array-like of length len(analytes)</span>
<span class="sd">            An array of numbers specifying the importance of</span>
<span class="sd">            each analyte considered. Larger number makes the</span>
<span class="sd">            analyte have a greater effect on the optimisation.</span>
<span class="sd">            Default is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">analytes</span><span class="p">)</span>

        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Optimising&#39;</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">signal_optimiser</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="n">min_points</span><span class="p">,</span>
                                              <span class="n">threshold_mode</span><span class="p">,</span> <span class="n">threshold_mult</span><span class="p">,</span>
                                              <span class="n">x_bias</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">A Few Problems:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">  *** Check Optimisation Plots ***&#39;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="analyse.optimisation_plots"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.optimisation_plots">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">optimisation_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the result of signal_optimise.</span>

<span class="sd">        `signal_optimiser` must be run first, and the output</span>
<span class="sd">        stored in the `opt` attribute of the latools.D object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d : latools.D object</span>
<span class="sd">            A latools data object.</span>
<span class="sd">        overlay_alpha : float</span>
<span class="sd">            The opacity of the threshold overlays. Between 0 and 1.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Passed to `tplot`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span> <span class="o">+</span> <span class="s1">&#39;/optimisation_plots/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Drawing Plots&#39;</span><span class="p">):</span>
            <span class="n">figs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">optimisation_plot</span><span class="p">(</span><span class="n">overlay_alpha</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;_optim_</span><span class="si">{:.0f}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.fit_classifier"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.fit_classifier">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">fit_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">analytes</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a clustering classifier based on all samples, or a subset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the classifier.</span>
<span class="sd">        analytes : str or iterable</span>
<span class="sd">            Which analytes the clustering algorithm should consider.</span>
<span class="sd">        method : str</span>
<span class="sd">            Which clustering algorithm to use. Can be:</span>

<span class="sd">            &#39;meanshift&#39;</span>
<span class="sd">                The `sklearn.cluster.MeanShift` algorithm.</span>
<span class="sd">                Automatically determines number of clusters</span>
<span class="sd">                in data based on the `bandwidth` of expected</span>
<span class="sd">                variation.</span>
<span class="sd">            &#39;kmeans&#39;</span>
<span class="sd">                The `sklearn.cluster.KMeans` algorithm. Determines</span>
<span class="sd">                the characteristics of a known number of clusters</span>
<span class="sd">                within the data. Must provide `n_clusters` to specify</span>
<span class="sd">                the expected number of clusters.</span>
<span class="sd">        samples : iterable</span>
<span class="sd">            list of samples to consider. Overrides &#39;subset&#39;.</span>
<span class="sd">        subset : str</span>
<span class="sd">            The subset of samples used to fit the classifier. Ignored if</span>
<span class="sd">            &#39;samples&#39; is specified.</span>
<span class="sd">        sort_by : int</span>
<span class="sd">            Which analyte the resulting clusters should be sorted</span>
<span class="sd">            by - defaults to 0, which is the first analyte.</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            method-specific keyword parameters - see below.</span>
<span class="sd">        Meanshift Parameters</span>
<span class="sd">            bandwidth : str or float</span>
<span class="sd">                The bandwith (float) or bandwidth method (&#39;scott&#39; or &#39;silverman&#39;)</span>
<span class="sd">                used to estimate the data bandwidth.</span>
<span class="sd">            bin_seeding : bool</span>
<span class="sd">                Modifies the behaviour of the meanshift algorithm. Refer to</span>
<span class="sd">                sklearn.cluster.meanshift documentation.</span>
<span class="sd">        K - Means Parameters</span>
<span class="sd">            n_clusters : int</span>
<span class="sd">                The number of clusters expected in the data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        name : str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># isolate data</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">)</span>

        <span class="c1"># create classifer</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span>
                       <span class="n">sort_by</span><span class="p">)</span>
        <span class="c1"># fit classifier</span>
        <span class="n">c</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="p">,</span>
              <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifiers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

        <span class="k">return</span> <span class="n">name</span></div>

<div class="viewcode-block" id="analyse.apply_classifier"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.apply_classifier">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">apply_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a clustering classifier based on all samples, or a subset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the classifier to apply.</span>
<span class="sd">        subset : str</span>
<span class="sd">            The subset of samples to apply the classifier to.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        name : str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifiers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">labs</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ulabels_</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Applying &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; classifier&#39;</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">focus</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># in case there&#39;s no data</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Time</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labs</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">f</span> <span class="o">==</span> <span class="n">l</span>
                <span class="n">d</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">{:.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">),</span>
                           <span class="n">filt</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
                           <span class="n">info</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s1">&#39; classifier&#39;</span><span class="p">,</span>
                           <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">analytes</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">method</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">name</span></div>

    <span class="c1"># plot calibrations</span>
<div class="viewcode-block" id="analyse.calibration_plot"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.calibration_plot">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">calibration_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datarange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">loglog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">plot</span><span class="o">.</span><span class="n">calibration_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="p">,</span> <span class="n">datarange</span><span class="p">,</span> <span class="n">loglog</span><span class="p">,</span> <span class="n">save</span><span class="p">)</span></div>

    <span class="c1"># set the focus attribute for specified samples</span>
<div class="viewcode-block" id="analyse.set_focus"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.set_focus">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">set_focus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focus_stage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the &#39;focus&#39; attribute of the data file.</span>

<span class="sd">        The &#39;focus&#39; attribute of the object points towards data from a</span>
<span class="sd">        particular stage of analysis. It is used to identify the &#39;working</span>
<span class="sd">        stage&#39; of the data. Processing functions operate on the &#39;focus&#39;</span>
<span class="sd">        stage, so if steps are done out of sequence, things will break.</span>

<span class="sd">        Names of analysis stages:</span>

<span class="sd">        * &#39;rawdata&#39;: raw data, loaded from csv file when object</span>
<span class="sd">          is initialised.</span>
<span class="sd">        * &#39;despiked&#39;: despiked data.</span>
<span class="sd">        * &#39;signal&#39;/&#39;background&#39;: isolated signal and background data,</span>
<span class="sd">          padded with np.nan. Created by self.separate, after</span>
<span class="sd">          signal and background regions have been identified by</span>
<span class="sd">          self.autorange.</span>
<span class="sd">        * &#39;bkgsub&#39;: background subtracted data, created by</span>
<span class="sd">          self.bkg_correct</span>
<span class="sd">        * &#39;ratios&#39;: element ratio data, created by self.ratio.</span>
<span class="sd">        * &#39;calibrated&#39;: ratio data calibrated to standards, created by</span>
<span class="sd">          self.calibrate.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        focus : str</span>
<span class="sd">            The name of the analysis stage desired.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">focus_stage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">focus_stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span> <span class="o">=</span> <span class="n">focus_stage</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">setfocus</span><span class="p">(</span><span class="n">focus_stage</span><span class="p">)</span></div>

    <span class="c1"># fetch all the data from the data objects</span>
<div class="viewcode-block" id="analyse.get_focus"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.get_focus">[docs]</a>    <span class="k">def</span> <span class="nf">get_focus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nominal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect all data from all samples into a single array.</span>
<span class="sd">        Data from standards is not collected.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filt : str, dict or bool</span>
<span class="sd">            Either logical filter expression contained in a str,</span>
<span class="sd">            a dict of expressions specifying the filter string to</span>
<span class="sd">            use for each analyte or a boolean. Passed to `grab_filt`.</span>
<span class="sd">        samples : str or list</span>
<span class="sd">            which samples to get</span>
<span class="sd">        subset : str or int</span>
<span class="sd">            which subset to get</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="c1"># t = 0</span>
        <span class="n">focus</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uTime&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">focus</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">a</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">sa</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sa</span><span class="p">]</span>
            <span class="n">focus</span><span class="p">[</span><span class="s1">&#39;uTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">uTime</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">grab_filt</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">focus</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">tmp</span><span class="p">[</span><span class="o">~</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">focus</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nominal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="ow">in</span> <span class="n">focus</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="ow">in</span> <span class="n">focus</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="k">return</span></div>

    <span class="c1"># fetch all the gradients from the data objects</span>
<div class="viewcode-block" id="analyse.get_gradients"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.get_gradients">[docs]</a>    <span class="k">def</span> <span class="nf">get_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect all data from all samples into a single array.</span>
<span class="sd">        Data from standards is not collected.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filt : str, dict or bool</span>
<span class="sd">            Either logical filter expression contained in a str,</span>
<span class="sd">            a dict of expressions specifying the filter string to</span>
<span class="sd">            use for each analyte or a boolean. Passed to `grab_filt`.</span>
<span class="sd">        samples : str or list</span>
<span class="sd">            which samples to get</span>
<span class="sd">        subset : str or int</span>
<span class="sd">            which subset to get</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;gradients&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="c1"># t = 0</span>
        <span class="n">focus</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uTime&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">focus</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">a</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">sa</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Calculating Gradients&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sa</span><span class="p">]</span>
            <span class="n">focus</span><span class="p">[</span><span class="s1">&#39;uTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">uTime</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">grab_filt</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="n">calc_grads</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">uTime</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">focus</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">analytes</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">grads</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="n">tmp</span><span class="p">[</span><span class="o">~</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">focus</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="ow">in</span> <span class="n">focus</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.gradient_histogram"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.gradient_histogram">[docs]</a>    <span class="k">def</span> <span class="nf">gradient_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a histogram of the gradients in all samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filt : str, dict or bool</span>
<span class="sd">            Either logical filter expression contained in a str,</span>
<span class="sd">            a dict of expressions specifying the filter string to</span>
<span class="sd">            use for each analyte or a boolean. Passed to `grab_filt`.</span>
<span class="sd">        bins : None or array-like</span>
<span class="sd">            The bins to use in the histogram</span>
<span class="sd">        samples : str or list</span>
<span class="sd">            which samples to get</span>
<span class="sd">        subset : str or int</span>
<span class="sd">            which subset to get</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig, ax</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;gradients&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_gradients</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">analytes</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">analytes</span><span class="p">),</span> <span class="mf">2.5</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="n">axs</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>

            <span class="n">m</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">unitpicker</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">focus_stage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span><span class="p">,</span> <span class="n">denominator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ibins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">]),</span> <span class="mi">50</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ibins</span> <span class="o">=</span> <span class="n">bins</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">ibins</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.7</span><span class="p">))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">is_first_col</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">u</span> <span class="o">+</span> <span class="s1">&#39;/s&#39;</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span></div>

    <span class="c1"># crossplot of all data</span>
<div class="viewcode-block" id="analyse.crossplot"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.crossplot">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">crossplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lognorm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">colourful</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;hist2d&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot analytes against each other.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : optional, array_like or str</span>
<span class="sd">            The analyte(s) to plot. Defaults to all analytes.</span>
<span class="sd">        lognorm : bool</span>
<span class="sd">            Whether or not to log normalise the colour scale</span>
<span class="sd">            of the 2D histogram.</span>
<span class="sd">        bins : int</span>
<span class="sd">            The number of bins in the 2D histogram.</span>
<span class="sd">        filt : str, dict or bool</span>
<span class="sd">            Either logical filter expression contained in a str,</span>
<span class="sd">            a dict of expressions specifying the filter string to</span>
<span class="sd">            use for each analyte or a boolean. Passed to `grab_filt`.</span>
<span class="sd">        figsize : tuple</span>
<span class="sd">            Figure size (width, height) in inches.</span>
<span class="sd">        save : bool or str</span>
<span class="sd">            If True, plot is saves as &#39;crossplot.png&#39;, if str plot is</span>
<span class="sd">            saves as str.</span>
<span class="sd">        colourful : bool</span>
<span class="sd">            Whether or not the plot should be colourful :).</span>
<span class="sd">        mode : str</span>
<span class="sd">            &#39;hist2d&#39; (default) or &#39;scatter&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (fig, axes)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">]:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>

        <span class="c1"># sort analytes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;[0-9.-]+&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">analytes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">crossplot</span><span class="p">(</span><span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">analytes</span><span class="p">,</span> <span class="n">lognorm</span><span class="o">=</span><span class="n">lognorm</span><span class="p">,</span>
                                   <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">colourful</span><span class="o">=</span><span class="n">colourful</span><span class="p">,</span>
                                   <span class="n">focus_stage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">,</span>
                                   <span class="n">denominator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">save</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span> <span class="o">+</span> <span class="s1">&#39;/crossplot.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>

<div class="viewcode-block" id="analyse.gradient_crossplot"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.gradient_crossplot">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">gradient_crossplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">lognorm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">colourful</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;hist2d&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot analyte gradients against each other.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : optional, array_like or str</span>
<span class="sd">            The analyte(s) to plot. Defaults to all analytes.</span>
<span class="sd">        lognorm : bool</span>
<span class="sd">            Whether or not to log normalise the colour scale</span>
<span class="sd">            of the 2D histogram.</span>
<span class="sd">        bins : int</span>
<span class="sd">            The number of bins in the 2D histogram.</span>
<span class="sd">        filt : str, dict or bool</span>
<span class="sd">            Either logical filter expression contained in a str,</span>
<span class="sd">            a dict of expressions specifying the filter string to</span>
<span class="sd">            use for each analyte or a boolean. Passed to `grab_filt`.</span>
<span class="sd">        figsize : tuple</span>
<span class="sd">            Figure size (width, height) in inches.</span>
<span class="sd">        save : bool or str</span>
<span class="sd">            If True, plot is saves as &#39;crossplot.png&#39;, if str plot is</span>
<span class="sd">            saves as str.</span>
<span class="sd">        colourful : bool</span>
<span class="sd">            Whether or not the plot should be colourful :).</span>
<span class="sd">        mode : str</span>
<span class="sd">            &#39;hist2d&#39; (default) or &#39;scatter&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (fig, axes)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">]:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>

        <span class="c1"># sort analytes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;[0-9.-]+&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">analytes</span><span class="p">)</span>

        <span class="c1"># calculate gradients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_gradients</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">subset</span><span class="p">)</span>

        <span class="c1"># self.get_focus(filt=filt, samples=samples, subset=subset)</span>
        <span class="c1"># grads = calc_grads(self.focus.uTime, self.focus, analytes, win)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">crossplot</span><span class="p">(</span><span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">analytes</span><span class="p">,</span> <span class="n">lognorm</span><span class="o">=</span><span class="n">lognorm</span><span class="p">,</span>
                                   <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">colourful</span><span class="o">=</span><span class="n">colourful</span><span class="p">,</span>
                                   <span class="n">focus_stage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">,</span>
                                   <span class="n">denominator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span> <span class="o">+</span> <span class="s1">&#39;/g_crossplot.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>

<div class="viewcode-block" id="analyse.histograms"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.histograms">[docs]</a>    <span class="k">def</span> <span class="nf">histograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">filt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">colourful</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot histograms of analytes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : optional, array_like or str</span>
<span class="sd">            The analyte(s) to plot. Defaults to all analytes.</span>
<span class="sd">        bins : int</span>
<span class="sd">            The number of bins in each histogram (default = 25)</span>
<span class="sd">        logy : bool</span>
<span class="sd">            If true, y axis is a log scale.</span>
<span class="sd">        filt : str, dict or bool</span>
<span class="sd">            Either logical filter expression contained in a str,</span>
<span class="sd">            a dict of expressions specifying the filter string to</span>
<span class="sd">            use for each analyte or a boolean. Passed to `grab_filt`.</span>
<span class="sd">        colourful : bool</span>
<span class="sd">            If True, histograms are colourful :)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (fig, axes)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">]:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">colourful</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">histograms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">analytes</span><span class="p">,</span>
                                    <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="n">logy</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>
    
<div class="viewcode-block" id="analyse.filter_effect"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_effect">[docs]</a>    <span class="k">def</span> <span class="nf">filter_effect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">filt</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Quantify the effects of the active filters.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : str or list</span>
<span class="sd">            Which analytes to consider.</span>
<span class="sd">        stats : list</span>
<span class="sd">            Which statistics to calculate.</span>
<span class="sd">        file : valid filter string or bool</span>
<span class="sd">            Which filter to consider. If True, applies all</span>
<span class="sd">            active filters.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            Contains statistics calculated for filtered and</span>
<span class="sd">            unfiltered data, and the filtered/unfiltered ratio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>
        
        <span class="c1"># calculate filtered and unfiltered stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_stats</span><span class="p">([</span><span class="s1">&#39;La139&#39;</span><span class="p">,</span> <span class="s1">&#39;Ti49&#39;</span><span class="p">],</span> <span class="n">stats</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">suf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_stats</span><span class="p">([</span><span class="s1">&#39;La139&#39;</span><span class="p">,</span> <span class="s1">&#39;Ti49&#39;</span><span class="p">],</span> <span class="n">stats</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">)</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># create dataframe for results</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_calced</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;unfiltered_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="s1">&#39;filtered_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span> 

        <span class="n">comp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span>
                            <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([</span><span class="n">cols</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)]))</span>

        <span class="c1"># collate stats</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">suf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">vf</span> <span class="o">=</span> <span class="n">sf</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;analytes&#39;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_calced</span><span class="p">:</span>
                    <span class="n">comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;unfiltered_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;filtered_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vf</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># calculate filtered/unfiltered ratios</span>
        <span class="n">rats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_calced</span><span class="p">:</span>
            <span class="n">rat</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;filtered_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span> <span class="o">/</span> <span class="n">comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;unfiltered_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
            <span class="n">rat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_ratio&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)],</span> <span class="n">rat</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
            <span class="n">rats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rat</span><span class="p">)</span>
        
        <span class="c1"># join it all up</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rats</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[:],</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[</span><span class="n">analytes</span><span class="p">])]</span></div>

<div class="viewcode-block" id="analyse.crossplot_filters"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.crossplot_filters">[docs]</a>    <span class="k">def</span> <span class="nf">crossplot_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_string</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the results of a group of filters in a crossplot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filter_string : str</span>
<span class="sd">            A string that identifies a group of filters.</span>
<span class="sd">            e.g. &#39;test&#39; would plot all filters with &#39;test&#39; in the</span>
<span class="sd">            name.</span>
<span class="sd">        analytes : optional, array_like or str</span>
<span class="sd">            The analyte(s) to plot. Defaults to all analytes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig, axes objects</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span> <span class="k">if</span> <span class="s1">&#39;Ca&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="c1"># isolate relevant filters</span>
        <span class="n">filts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">cfilts</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filts</span> <span class="k">if</span> <span class="n">filter_string</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="n">flab</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.*_(.*)$&#39;</span><span class="p">)</span>  <span class="c1"># regex to get filter name</span>

        <span class="c1"># aggregate data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">)</span>

        <span class="c1"># set up axes</span>
        <span class="n">numvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">analytes</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">numvars</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">numvars</span><span class="p">,</span>
                                 <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">is_first_col</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">is_last_col</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">is_first_row</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">is_last_row</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

        <span class="n">cmlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="s1">&#39;BuGn&#39;</span><span class="p">,</span> <span class="s1">&#39;BuPu&#39;</span><span class="p">,</span> <span class="s1">&#39;GnBu&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Greens&#39;</span><span class="p">,</span> <span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="s1">&#39;Oranges&#39;</span><span class="p">,</span> <span class="s1">&#39;OrRd&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;PuBu&#39;</span><span class="p">,</span> <span class="s1">&#39;PuBuGn&#39;</span><span class="p">,</span> <span class="s1">&#39;PuRd&#39;</span><span class="p">,</span> <span class="s1">&#39;Purples&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;RdPu&#39;</span><span class="p">,</span> <span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="s1">&#39;YlGn&#39;</span><span class="p">,</span> <span class="s1">&#39;YlGnBu&#39;</span><span class="p">,</span> <span class="s1">&#39;YlOrBr&#39;</span><span class="p">,</span> <span class="s1">&#39;YlOrRd&#39;</span><span class="p">]</span>

        <span class="c1"># isolate nominal_values for all analytes</span>
        <span class="n">focus</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="c1"># determine units for all analytes</span>
        <span class="n">udict</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">unitpicker</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">focus</span><span class="p">[</span><span class="n">a</span><span class="p">]),</span>
                               <span class="n">focus_stage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span><span class="p">,</span>
                               <span class="n">denominator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">}</span>
        <span class="c1"># determine ranges for all analytes</span>
        <span class="n">rdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">focus</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">udict</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">focus</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">udict</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cfilts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">)</span>
            <span class="n">focus</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">lab</span> <span class="o">=</span> <span class="n">flab</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices_from</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
                <span class="c1"># get analytes</span>
                <span class="n">ai</span> <span class="o">=</span> <span class="n">analytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">aj</span> <span class="o">=</span> <span class="n">analytes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                <span class="c1"># remove nan, apply multipliers</span>
                <span class="n">pi</span> <span class="o">=</span> <span class="n">focus</span><span class="p">[</span><span class="n">ai</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">focus</span><span class="p">[</span><span class="n">ai</span><span class="p">])]</span> <span class="o">*</span> <span class="n">udict</span><span class="p">[</span><span class="n">ai</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pj</span> <span class="o">=</span> <span class="n">focus</span><span class="p">[</span><span class="n">aj</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">focus</span><span class="p">[</span><span class="n">aj</span><span class="p">])]</span> <span class="o">*</span> <span class="n">udict</span><span class="p">[</span><span class="n">aj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># make plot</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pj</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">rdict</span><span class="p">[</span><span class="n">ai</span><span class="p">])</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">rdict</span><span class="p">[</span><span class="n">aj</span><span class="p">])</span>

                <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">rdict</span><span class="p">[</span><span class="n">aj</span><span class="p">])</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">rdict</span><span class="p">[</span><span class="n">ai</span><span class="p">])</span>

        <span class="c1"># diagonal labels</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">analytes</span><span class="p">))):</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">udict</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                                <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">rdict</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">rdict</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">filter_string</span><span class="p">)</span>

        <span class="c1"># switch on alternating axes</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numvars</span><span class="p">),</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))):</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>

    <span class="c1"># Plot traces</span>
<div class="viewcode-block" id="analyse.trace_plots"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.trace_plots">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">trace_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">focus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;nanmean&#39;</span><span class="p">,</span>
                    <span class="n">err</span><span class="o">=</span><span class="s1">&#39;nanstd&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;All_Analyses&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot analytes as a function of time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : optional, array_like or str</span>
<span class="sd">            The analyte(s) to plot. Defaults to all analytes.</span>
<span class="sd">        samples: optional, array_like or str</span>
<span class="sd">            The sample(s) to plot. Defaults to all samples.</span>
<span class="sd">        ranges : bool</span>
<span class="sd">            Whether or not to show the signal/backgroudn regions</span>
<span class="sd">            identified by &#39;autorange&#39;.</span>
<span class="sd">        focus : str</span>
<span class="sd">            The focus &#39;stage&#39; of the analysis to plot. Can be</span>
<span class="sd">            &#39;rawdata&#39;, &#39;despiked&#39;:, &#39;signal&#39;, &#39;background&#39;,</span>
<span class="sd">            &#39;bkgsub&#39;, &#39;ratios&#39; or &#39;calibrated&#39;.</span>
<span class="sd">        outdir : str</span>
<span class="sd">            Path to a directory where you&#39;d like the plots to be</span>
<span class="sd">            saved. Defaults to &#39;reports/[focus]&#39; in your data directory.</span>
<span class="sd">        filt : str, dict or bool</span>
<span class="sd">            Either logical filter expression contained in a str,</span>
<span class="sd">            a dict of expressions specifying the filter string to</span>
<span class="sd">            use for each analyte or a boolean. Passed to `grab_filt`.</span>
<span class="sd">        scale : str</span>
<span class="sd">            If &#39;log&#39;, plots the data on a log scale.</span>
<span class="sd">        figsize : array_like</span>
<span class="sd">            Array of length 2 specifying figure [width, height] in</span>
<span class="sd">            inches.</span>
<span class="sd">        stats : bool</span>
<span class="sd">            Whether or not to overlay the mean and standard deviations</span>
<span class="sd">            for each trace.</span>
<span class="sd">        stat, err: str</span>
<span class="sd">            The names of the statistic and error components to plot.</span>
<span class="sd">            Deafaults to &#39;nanmean&#39; and &#39;nanstd&#39;.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">focus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">focus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">focus</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="c1"># if samples is not None:</span>
        <span class="c1">#     subset = self.make_subset(samples)</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;All_Analyses&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">samples</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Drawing Plots&#39;</span><span class="p">):</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">tplot</span><span class="p">(</span><span class="n">analytes</span><span class="o">=</span><span class="n">analytes</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                      <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span>
                                      <span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span>
                                      <span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">focus_stage</span><span class="o">=</span><span class="n">focus</span><span class="p">)</span>
            <span class="c1"># ax = fig.axes[0]</span>
            <span class="c1"># for l, u in s.sigrng:</span>
            <span class="c1">#     ax.axvspan(l, u, color=&#39;r&#39;, alpha=0.1)</span>
            <span class="c1"># for l, u in s.bkgrng:</span>
            <span class="c1">#     ax.axvspan(l, u, color=&#39;k&#39;, alpha=0.1)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;_traces.pdf&#39;</span><span class="p">)</span>
            <span class="c1"># TODO: on older(?) computers raises</span>
            <span class="c1"># &#39;OSError: [Errno 24] Too many open files&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="c1"># Plot gradients</span>
<div class="viewcode-block" id="analyse.gradient_plots"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.gradient_plots">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">gradient_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">focus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;All_Analyses&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot analyte gradients as a function of time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : optional, array_like or str</span>
<span class="sd">            The analyte(s) to plot. Defaults to all analytes.</span>
<span class="sd">        samples: optional, array_like or str</span>
<span class="sd">            The sample(s) to plot. Defaults to all samples.</span>
<span class="sd">        ranges : bool</span>
<span class="sd">            Whether or not to show the signal/backgroudn regions</span>
<span class="sd">            identified by &#39;autorange&#39;.</span>
<span class="sd">        focus : str</span>
<span class="sd">            The focus &#39;stage&#39; of the analysis to plot. Can be</span>
<span class="sd">            &#39;rawdata&#39;, &#39;despiked&#39;:, &#39;signal&#39;, &#39;background&#39;,</span>
<span class="sd">            &#39;bkgsub&#39;, &#39;ratios&#39; or &#39;calibrated&#39;.</span>
<span class="sd">        outdir : str</span>
<span class="sd">            Path to a directory where you&#39;d like the plots to be</span>
<span class="sd">            saved. Defaults to &#39;reports/[focus]&#39; in your data directory.</span>
<span class="sd">        filt : str, dict or bool</span>
<span class="sd">            Either logical filter expression contained in a str,</span>
<span class="sd">            a dict of expressions specifying the filter string to</span>
<span class="sd">            use for each analyte or a boolean. Passed to `grab_filt`.</span>
<span class="sd">        scale : str</span>
<span class="sd">            If &#39;log&#39;, plots the data on a log scale.</span>
<span class="sd">        figsize : array_like</span>
<span class="sd">            Array of length 2 specifying figure [width, height] in</span>
<span class="sd">            inches.</span>
<span class="sd">        stats : bool</span>
<span class="sd">            Whether or not to overlay the mean and standard deviations</span>
<span class="sd">            for each trace.</span>
<span class="sd">        stat, err: str</span>
<span class="sd">            The names of the statistic and error components to plot.</span>
<span class="sd">            Deafaults to &#39;nanmean&#39; and &#39;nanstd&#39;.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">focus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">focus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">focus</span> <span class="o">+</span> <span class="s1">&#39;_gradient&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="c1"># if samples is not None:</span>
        <span class="c1">#     subset = self.make_subset(samples)</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsets</span><span class="p">[</span><span class="s1">&#39;All_Analyses&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">samples</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Drawing Plots&#39;</span><span class="p">):</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">gplot</span><span class="p">(</span><span class="n">analytes</span><span class="o">=</span><span class="n">analytes</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                      <span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span> <span class="n">focus_stage</span><span class="o">=</span><span class="n">focus</span><span class="p">)</span>
            <span class="c1"># ax = fig.axes[0]</span>
            <span class="c1"># for l, u in s.sigrng:</span>
            <span class="c1">#     ax.axvspan(l, u, color=&#39;r&#39;, alpha=0.1)</span>
            <span class="c1"># for l, u in s.bkgrng:</span>
            <span class="c1">#     ax.axvspan(l, u, color=&#39;k&#39;, alpha=0.1)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;_gradients.pdf&#39;</span><span class="p">)</span>
            <span class="c1"># TODO: on older(?) computers raises</span>
            <span class="c1"># &#39;OSError: [Errno 24] Too many open files&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="c1"># filter reports</span>
<div class="viewcode-block" id="analyse.filter_reports"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.filter_reports">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">filter_reports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="p">,</span> <span class="n">filt_str</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;All_Samples&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot filter reports for all filters that contain ``filt_str``</span>
<span class="sd">        in the name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span> <span class="o">+</span> <span class="s1">&#39;/filters/&#39;</span> <span class="o">+</span> <span class="n">filt_str</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span> <span class="o">+</span> <span class="s1">&#39;/filters&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_dir</span> <span class="o">+</span> <span class="s1">&#39;/filters&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Drawing Plots&#39;</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filter_report</span><span class="p">(</span><span class="n">filt</span><span class="o">=</span><span class="n">filt_str</span><span class="p">,</span>
                                           <span class="n">analytes</span><span class="o">=</span><span class="n">analytes</span><span class="p">,</span>
                                           <span class="n">savedir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                                           <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">)</span>
            <span class="c1"># plt.close(fig)</span>
        <span class="k">return</span></div>

    <span class="c1"># def _stat_boostrap(self, analytes=None, filt=True,</span>
    <span class="c1">#                    stat_fn=np.nanmean, ci=95):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Calculate sample statistics with bootstrapped confidence intervals.</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     analytes : optional, array_like or str</span>
    <span class="c1">#         The analyte(s) to calculate statistics for. Defaults to</span>
    <span class="c1">#         all analytes.</span>
    <span class="c1">#     filt : str, dict or bool</span>
    <span class="c1">#         Either logical filter expression contained in a str,</span>
    <span class="c1">#         a dict of expressions specifying the filter string to</span>
    <span class="c1">#         use for each analyte or a boolean. Passed to `grab_filt`.</span>
    <span class="c1">#     stat_fns : array_like</span>
    <span class="c1">#         list of functions that take a single array_like input,</span>
    <span class="c1">#         and return a single statistic. Function should be able</span>
    <span class="c1">#         to cope with numpy NaN values.</span>
    <span class="c1">#     ci : float</span>
    <span class="c1">#         Confidence interval to calculate.</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     None</span>
    <span class="c1">#     &quot;&quot;&quot;</span>

    <span class="c1">#     return</span>

<div class="viewcode-block" id="analyse.sample_stats"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.sample_stats">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">sample_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">],</span>
                     <span class="n">eachtrace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">csf_dict</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate sample statistics.</span>

<span class="sd">        Returns samples, analytes, and arrays of statistics</span>
<span class="sd">        of shape (samples, analytes). Statistics are calculated</span>
<span class="sd">        from the &#39;focus&#39; data variable, so output depends on how</span>
<span class="sd">        the data have been processed.</span>

<span class="sd">        Included stat functions:</span>

<span class="sd">        * :func:`~latools.stat_fns.mean`: arithmetic mean</span>
<span class="sd">        * :func:`~latools.stat_fns.std`: arithmetic standard deviation</span>
<span class="sd">        * :func:`~latools.stat_fns.se`: arithmetic standard error</span>
<span class="sd">        * :func:`~latools.stat_fns.H15_mean`: Huber mean (outlier removal)</span>
<span class="sd">        * :func:`~latools.stat_fns.H15_std`: Huber standard deviation (outlier removal)</span>
<span class="sd">        * :func:`~latools.stat_fns.H15_se`: Huber standard error (outlier removal)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : optional, array_like or str</span>
<span class="sd">            The analyte(s) to calculate statistics for. Defaults to</span>
<span class="sd">            all analytes.</span>
<span class="sd">        filt : str, dict or bool</span>
<span class="sd">            Either logical filter expression contained in a str,</span>
<span class="sd">            a dict of expressions specifying the filter string to</span>
<span class="sd">            use for each analyte or a boolean. Passed to `grab_filt`.</span>
<span class="sd">        stats : array_like</span>
<span class="sd">            take a single array_like input, and return a single statistic. </span>
<span class="sd">            list of functions or names (see above) or functions that</span>
<span class="sd">            Function should be able to cope with NaN values.</span>
<span class="sd">        eachtrace : bool</span>
<span class="sd">            Whether to calculate the statistics for each analysis</span>
<span class="sd">            spot individually, or to produce per - sample means.</span>
<span class="sd">            Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Adds dict to analyse object containing samples, analytes and</span>
<span class="sd">            functions and data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats_calced</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stat_fns</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>

        <span class="n">stat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">,</span>
                     <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">,</span>
                     <span class="s1">&#39;nanmean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">,</span>
                     <span class="s1">&#39;nanstd&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">,</span>
                     <span class="s1">&#39;se&#39;</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span>
                     <span class="s1">&#39;H15_mean&#39;</span><span class="p">:</span> <span class="n">H15_mean</span><span class="p">,</span>
                     <span class="s1">&#39;H15_std&#39;</span><span class="p">:</span> <span class="n">H15_std</span><span class="p">,</span>
                     <span class="s1">&#39;H15_se&#39;</span><span class="p">:</span> <span class="n">H15_se</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stat_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stats_calced</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">stat_fns</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_dict</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">csf_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stats_calced</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">exec</span><span class="p">(</span><span class="n">csf_dict</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                    <span class="n">stat_fns</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_calced</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="n">stat_fns</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;custom_stat_functions&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">custom_stat_functions</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">custom_stat_functions</span> <span class="o">+=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n\n\n</span><span class="s1">&#39;</span>

        <span class="c1"># calculate stats for each sample</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Calculating Stats&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">srm_identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sample_stats</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span>
                                          <span class="n">stat_fns</span><span class="o">=</span><span class="n">stat_fns</span><span class="p">,</span>
                                          <span class="n">eachtrace</span><span class="o">=</span><span class="n">eachtrace</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span></div>

<div class="viewcode-block" id="analyse.ablation_times"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.ablation_times">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">ablation_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="n">ats</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="n">ats</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">ablation_times</span><span class="p">()</span>

        <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">ats</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
            <span class="n">td</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span>
            <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">td</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">samples</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;rep&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span></div>

    <span class="c1"># function for visualising sample statistics</span>
<div class="viewcode-block" id="analyse.statplot"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.statplot">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">statplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for visualising per-ablation and per-sample means.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        analytes : str or iterable</span>
<span class="sd">            Which analyte(s) to plot</span>
<span class="sd">        samples : str or iterable</span>
<span class="sd">            Which sample(s) to plot</span>
<span class="sd">        figsize : tuple</span>
<span class="sd">            Figure (width, height) in inches</span>
<span class="sd">        stat : str</span>
<span class="sd">            Which statistic to plot. Must match</span>
<span class="sd">            the name of the functions used in </span>
<span class="sd">            &#39;sample_stats&#39;.</span>
<span class="sd">        err : str</span>
<span class="sd">            Which uncertainty to plot.</span>
<span class="sd">        subset : str</span>
<span class="sd">            Which subset of samples to plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;stats&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_stats</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">),</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">analytes</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">analytes</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">an</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">analytes</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">stab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getstats</span><span class="p">()</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">unitpicker</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">stab</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">an</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="mi">25</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">,</span>
                              <span class="n">focus_stage</span><span class="o">=</span><span class="s1">&#39;calibrated&#39;</span><span class="p">,</span>
                              <span class="n">denominator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">srm_identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">stat</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">stat</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="o">.</span><span class="mi">1</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="o">.</span><span class="mi">1</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">a_ind</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;analytes&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">an</span>

                    <span class="c1"># plot individual ablations with error bars</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">stat</span><span class="p">][</span><span class="n">a_ind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span>
                                <span class="n">yerr</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="n">err</span><span class="p">][</span><span class="n">a_ind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span>
                                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">an</span><span class="p">],</span>
                                <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> / </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> )&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pretty_element</span><span class="p">(</span><span class="n">an</span><span class="p">),</span>
                                                     <span class="n">pretty_element</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">),</span>
                                                     <span class="n">u</span><span class="p">))</span>

                    <span class="c1"># plot whole - sample mean</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># mean calculation with error propagation?</span>
                        <span class="c1"># umean = un.uarray(d[stat][a_ind][0] * m, d[err][a_ind][0] * m).mean()</span>
                        <span class="c1"># std = un.std_devs(umean)</span>
                        <span class="c1"># mean = un.nominal_values(umean)</span>
                        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">stat</span><span class="p">][</span><span class="n">a_ind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
                        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">stat</span><span class="p">][</span><span class="n">a_ind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">mean</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">an</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">mean</span> <span class="o">+</span> <span class="n">std</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                        <span class="p">[</span><span class="n">mean</span> <span class="o">-</span> <span class="n">std</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                        <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">an</span><span class="p">])</span>

                    <span class="c1"># highlight each sample</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">)))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">)</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="analyse.getstats"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.getstats">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">getstats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ablation_time</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return pandas dataframe of all sample statistics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slst</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_calced</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">samples</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">srm_identifier</span>
                       <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">nm</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># make multi - index</span>
                    <span class="n">reps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">nm</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">reps</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">nms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nm</span><span class="p">]</span> <span class="o">*</span> <span class="n">reps</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="c1"># make sub - dataframe</span>
                    <span class="n">stdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">nm</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                        <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">nm</span><span class="p">][</span><span class="s1">&#39;analytes&#39;</span><span class="p">],</span>
                                        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">ss</span><span class="p">,</span> <span class="n">nms</span><span class="p">,</span> <span class="n">reps</span><span class="p">])</span>
                    <span class="n">stdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">([</span><span class="s1">&#39;statistic&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;rep&#39;</span><span class="p">],</span>
                                         <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">nm</span><span class="p">][</span><span class="n">s</span><span class="p">],</span>
                                        <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">nm</span><span class="p">][</span><span class="s1">&#39;analytes&#39;</span><span class="p">],</span>
                                        <span class="n">columns</span><span class="o">=</span><span class="p">[[</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="n">nm</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

                    <span class="n">stdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">([</span><span class="s1">&#39;statistic&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">],</span>
                                         <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">slst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stdf</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">slst</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ablation_time</span><span class="p">:</span>
            <span class="n">ats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ablation_times</span><span class="p">(</span><span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">)</span>
            <span class="n">ats</span><span class="p">[</span><span class="s1">&#39;statistic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nanmean&#39;</span>
            <span class="n">ats</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;statistic&#39;</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ats</span> <span class="o">=</span> <span class="n">ats</span><span class="o">.</span><span class="n">reorder_levels</span><span class="p">([</span><span class="s1">&#39;statistic&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;rep&#39;</span><span class="p">])</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ats</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;stat_export.csv&#39;</span>
            <span class="n">out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">out</span>

        <span class="k">return</span> <span class="n">out</span></div>

    <span class="c1"># raw data export function</span>
    <span class="k">def</span> <span class="nf">_minimal_export_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;All_Analyses&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used for exporting minimal dataset. DON&#39;T USE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="n">focus_stage</span> <span class="o">=</span> <span class="s1">&#39;rawdata&#39;</span>
        <span class="c1"># ud = &#39;counts&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">focus_stage</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>

            <span class="n">d</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;# Minimal Reproduction Dataset Exported from LATOOLS on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y:%m:</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)),</span>
                      <span class="s2">&quot;# Analysis described in &#39;../analysis.log&#39;&quot;</span><span class="p">,</span>
                      <span class="s1">&#39;# Run latools.reproduce to import analysis.&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;#&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;# Sample: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">),</span>
                      <span class="s1">&#39;# Analysis Time: &#39;</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)]</span>

            <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">csv</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">()</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">csv</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="analyse.export_traces"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.export_traces">[docs]</a>    <span class="nd">@_log</span>
    <span class="k">def</span> <span class="nf">export_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">focus_stage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;All_Analyses&#39;</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to export raw data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outdir : str</span>
<span class="sd">            directory to save toe traces. Defaults to &#39;main-dir-name_export&#39;.</span>
<span class="sd">        focus_stage : str</span>
<span class="sd">            The name of the analysis stage to export.</span>

<span class="sd">            * &#39;rawdata&#39;: raw data, loaded from csv file.</span>
<span class="sd">            * &#39;despiked&#39;: despiked data.</span>
<span class="sd">            * &#39;signal&#39;/&#39;background&#39;: isolated signal and background data.</span>
<span class="sd">              Created by self.separate, after signal and background</span>
<span class="sd">              regions have been identified by self.autorange.</span>
<span class="sd">            * &#39;bkgsub&#39;: background subtracted data, created by </span>
<span class="sd">              self.bkg_correct</span>
<span class="sd">            * &#39;ratios&#39;: element ratio data, created by self.ratio.</span>
<span class="sd">            * &#39;calibrated&#39;: ratio data calibrated to standards, created by self.calibrate.</span>

<span class="sd">            Defaults to the most recent stage of analysis.</span>
<span class="sd">        analytes : str or array - like</span>
<span class="sd">            Either a single analyte, or list of analytes to export.</span>
<span class="sd">            Defaults to all analytes.</span>
<span class="sd">        samples : str or array - like</span>
<span class="sd">            Either a single sample name, or list of samples to export.</span>
<span class="sd">            Defaults to all samples.</span>
<span class="sd">        filt : str, dict or bool</span>
<span class="sd">            Either logical filter expression contained in a str,</span>
<span class="sd">            a dict of expressions specifying the filter string to</span>
<span class="sd">            use for each analyte or a boolean. Passed to `grab_filt`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_subset</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_samples</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">focus_stage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">focus_stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus_stage</span>

        <span class="k">if</span> <span class="n">focus_stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ratios&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">]:</span>
            <span class="n">analytes</span> <span class="o">=</span> <span class="n">analytes</span><span class="p">[</span><span class="n">analytes</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_dir</span>

        <span class="n">ud</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rawdata&#39;</span><span class="p">:</span> <span class="s1">&#39;counts&#39;</span><span class="p">,</span>
              <span class="s1">&#39;despiked&#39;</span><span class="p">:</span> <span class="s1">&#39;counts&#39;</span><span class="p">,</span>
              <span class="s1">&#39;bkgsub&#39;</span><span class="p">:</span> <span class="s1">&#39;background corrected counts&#39;</span><span class="p">,</span>
              <span class="s1">&#39;ratios&#39;</span><span class="p">:</span> <span class="s1">&#39;counts/count </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="p">,</span>
              <span class="s1">&#39;calibrated&#39;</span><span class="p">:</span> <span class="s1">&#39;mol/mol </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">focus_stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ratios&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">]:</span>
            <span class="n">ud</span><span class="p">[</span><span class="n">focus_stage</span><span class="p">]</span> <span class="o">=</span> <span class="n">ud</span><span class="p">[</span><span class="n">focus_stage</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_standard</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">focus_stage</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">filt</span><span class="o">.</span><span class="n">grab_filt</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">ind</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">focus_stage</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rawdata&#39;</span><span class="p">,</span> <span class="s1">&#39;despiked&#39;</span><span class="p">]:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_devs</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">ind</span><span class="p">])</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">Time</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">out</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>

            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;# Sample: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">),</span>
                      <span class="s1">&#39;# Data Exported from LATOOLS on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y:%m:</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)),</span>
                      <span class="s1">&#39;# Processed using </span><span class="si">%s</span><span class="s1"> configuration&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">),</span>
                      <span class="s1">&#39;# Analysis Stage: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">focus_stage</span><span class="p">),</span>
                      <span class="s1">&#39;# Unit: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ud</span><span class="p">[</span><span class="n">focus_stage</span><span class="p">]]</span>

            <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">csv</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">()</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">focus_stage</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">csv</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="analyse.minimal_export"><a class="viewcode-back" href="../../latools.html#latools.latools.analyse.minimal_export">[docs]</a>    <span class="k">def</span> <span class="nf">minimal_export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_analytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exports a analysis parameters, standard info and a minimal dataset,</span>
<span class="sd">        which can be imported by another user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">target_analytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_analytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytes</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_analytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">target_analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">target_analytes</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">target_analytes</span><span class="p">)</span>

        <span class="c1"># set up data path</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_dir</span> <span class="o">+</span> <span class="s1">&#39;/minimal_export/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># export data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minimal_export_traces</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/data&#39;</span><span class="p">,</span> <span class="n">analytes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="p">)</span>

        <span class="c1"># define analysis_log header</span>
        <span class="n">log_header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;# Minimal Reproduction Dataset Exported from LATOOLS on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y:%m:</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)),</span>
                      <span class="s1">&#39;data_folder :: ./data/&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;srm_table :: ./srm.table&#39;</span><span class="p">,</span>
                      <span class="p">]</span>

        <span class="c1"># save custom functions (of defined)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;custom_stat_functions&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/custom_stat_fns.py&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_stat_functions</span><span class="p">)</span>
            <span class="n">log_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;custom_stat_functions :: ./custom_stat_fns.py&#39;</span><span class="p">)</span>

        <span class="n">log_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# Analysis Log Start: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># format sample_stats correctly</span>
        <span class="n">lss</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;sample_stats&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(.*&#39;stats&#39;: )(\[.*?\])(.*)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rep</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\1&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_calced</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\3&#39;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>

        <span class="c1"># save log</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/analysis.log&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_header</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">))</span>

        <span class="c1"># export srm table</span>
        <span class="n">els</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimal_analytes</span><span class="p">])</span>
        <span class="n">srmdat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">els</span><span class="p">:</span>
            <span class="n">srmdat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srmdat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">srmdat</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">e</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">srmdat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">srmdat</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/srm.table&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">srmdat</span><span class="o">.</span><span class="n">to_csv</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="reproduce"><a class="viewcode-back" href="../../latools.html#latools.latools.reproduce">[docs]</a><span class="k">def</span> <span class="nf">reproduce</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">plotting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">srm_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">custom_stat_functions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reproduce a previous analysis exported with :func:`latools.analyse.minimal_export`</span>

<span class="sd">    For normal use, supplying `log_file` and specifying a plotting option should be</span>
<span class="sd">    enough to reproduce an analysis. All requisites (raw data, SRM table and any</span>
<span class="sd">    custom stat functions) will then be imported from the minimal_export folder.</span>

<span class="sd">    You may also specify your own raw_data, srm_table and custom_stat_functions,</span>
<span class="sd">    if you wish.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    log_file : str</span>
<span class="sd">        The path to the log file produced by :func:`~latools.analyse.minimal_export`.</span>
<span class="sd">    plotting : bool</span>
<span class="sd">        Whether or not to output plots.</span>
<span class="sd">    data_folder : str</span>
<span class="sd">        Optional. Specify a different data folder. Data folder</span>
<span class="sd">        should normally be in the same folder as the log file.</span>
<span class="sd">    srm_table : str</span>
<span class="sd">        Optional. Specify a different SRM table. SRM table</span>
<span class="sd">        should normally be in the same folder as the log file.</span>
<span class="sd">    custom_stat_functions : str</span>
<span class="sd">        Optional. Specify a python file containing custom</span>
<span class="sd">        stat functions for use by reproduce. Any custom</span>
<span class="sd">        stat functions should normally be included in the</span>
<span class="sd">        same folder as the log file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">rlog</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">hashind</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rlog</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>

    <span class="n">pathread</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;(.*) :: (.*)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">pathread</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">rlog</span><span class="p">[</span><span class="n">hashind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">hashind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="n">pathread</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">l</span><span class="p">)])</span>

    <span class="k">if</span> <span class="n">data_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_folder</span> <span class="o">=</span> <span class="n">dirname</span> <span class="o">+</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;data_folder&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">srm_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">srm_table</span> <span class="o">=</span> <span class="n">dirname</span> <span class="o">+</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;srm_table&#39;</span><span class="p">]</span>

    <span class="n">csfs</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">custom_stat_functions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;custom_stat_functions&#39;</span> <span class="ow">in</span> <span class="n">paths</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># load custom functions as a dict</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dirname</span> <span class="o">+</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;custom_stat_functions&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">csf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;def (.*)\(.*&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">csf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="n">csfs</span><span class="p">[</span><span class="n">fname</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">c</span>

    <span class="c1"># reproduce analysis</span>
    <span class="n">logread</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;([a-z_]+) :: args=(\(.*\)) kwargs=(\{.*\})&#39;</span><span class="p">)</span>

    <span class="n">init_kwargs</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">logread</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">rlog</span><span class="p">[</span><span class="n">hashind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">init_kwargs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;REPRODUCE&#39;</span>
    <span class="n">init_kwargs</span><span class="p">[</span><span class="s1">&#39;dataformat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">init_kwargs</span><span class="p">[</span><span class="s1">&#39;data_folder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_folder</span>

    <span class="n">dat</span> <span class="o">=</span> <span class="n">analyse</span><span class="p">(</span><span class="o">**</span><span class="n">init_kwargs</span><span class="p">)</span>

    <span class="n">dat</span><span class="o">.</span><span class="n">srmdat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">srm_table</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;SRM&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SRM values loaded from: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srm_table</span><span class="p">))</span>

    <span class="c1"># rest of commands</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">rlog</span><span class="p">[</span><span class="n">hashind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:]:</span>
        <span class="n">fname</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">logread</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;sample_stats&#39;</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">.</span><span class="n">sample_stats</span><span class="p">(</span><span class="o">*</span><span class="nb">eval</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">csf_dict</span><span class="o">=</span><span class="n">csfs</span><span class="p">,</span> <span class="o">**</span><span class="nb">eval</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fname</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">fname</span><span class="p">)(</span><span class="o">*</span><span class="nb">eval</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="o">**</span><span class="nb">eval</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">plotting</span><span class="p">:</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">fname</span><span class="p">)(</span><span class="o">*</span><span class="nb">eval</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="o">**</span><span class="nb">eval</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">dat</span></div>


<span class="n">analyze</span> <span class="o">=</span> <span class="n">analyse</span>  <span class="c1"># for the yanks</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Oscar Branson.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.3.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>